<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPAN网址收藏</title>
    <!-- 修复：移除被阻止的CDN，使用本地备用方案 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <!-- 修复：移除有问题的Sortable.css，使用内联样式替代 -->
    <style>
        :root {
            --primary-color: #3498db;
            --primary-light: #5dade2;
            --primary-dark: #2980b9;
            --accent-color: #2ecc71;
            --accent-light: #58d68d;
            --accent-dark: #27ae60;
            --bg-color: #f8fafc;
            --card-color: #ffffff;
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #e0e6ed;
            --shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        .dark-mode {
            --primary-color: #3498db;
            --primary-light: #5dade2;
            --primary-dark: #2980b9;
            --bg-color: #1a1a2e;
            --card-color: #16213e;
            --text-color: #e6e6e6;
            --text-light: #b0b0b0;
            --border-color: #2d3748;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* 修复：Token登录界面样式 */
        #tokenOverlay {
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        #tokenOverlay .token-box {
            background: var(--card-color);
            padding: 30px;
            border-radius: var(--radius);
            text-align: center;
            min-width: 300px;
            max-width: 400px;
            box-shadow: var(--shadow);
        }
        
        #tokenOverlay h3 {
            color: var(--text-color);
            margin-bottom: 10px;
        }
        
        #tokenOverlay p {
            color: var(--text-light);
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        #githubTokenInput {
            width: 100%;
            padding: 12px 15px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        #tokenOverlay button {
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        #tokenOverlay button:hover {
            background: var(--primary-dark);
        }
        
        /* 修复：确保主容器在未登录时隐藏 */
        .container {
            display: none; /* 初始隐藏，登录后显示 */
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* 页头样式 */
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            position: relative;
            z-index: 10;
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }
        
        .logo-text {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 1px;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .logo-subtext {
            font-size: 14px;
            font-weight: 500;
            margin-top: 2px;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }
        
        /* 搜索容器 - 优化布局 */
        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 15px;
            display: flex;
            position: relative;
        }
        
        .search-box {
            flex: 1;
            padding: 12px 85px 12px 45px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* 搜索图标在搜索框内左侧 */
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 本地搜索按钮在搜索框内右侧 */
        .local-search-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            color: var(--primary-color);
            border: none;
            width: 34px;
            height: 34px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 18px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .local-search-btn:hover {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-dark);
        }
        
        .local-search-btn.active {
            color: #f1c40f;
            background-color: rgba(241, 196, 15, 0.1);
        }
        
        /* 功能按钮区 */
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            width: 48px; /* 增大按钮宽度，便于移动端点击 */
            height: 48px; /* 增大按钮高度，便于移动端点击 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
            touch-action: manipulation; /* 优化触摸体验 */
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* 批量操作按钮 */
        .batch-operations-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            width: 48px; /* 增大按钮宽度，便于移动端点击 */
            height: 48px; /* 增大按钮高度，便于移动端点击 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
            touch-action: manipulation; /* 优化触摸体验 */
        }
        
        .batch-operations-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .batch-operations-btn.active {
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* 主体布局 */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* 左侧分类区 */
        .categories-sidebar {
            width: 260px;
            background-color: var(--card-color);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            transition: width 0.3s;
        }
        
        /* 分类标题栏 */
        .categories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .categories-title-row {
            display: flex;
            align-items: center;
            width: 100%;
        }
        
        .categories-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-right: auto;
        }
        
        .category-actions {
            display: flex;
            gap: 5px;
        }
        
        .add-category-btn, .category-settings-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 16px;
            cursor: pointer;
            width: 40px; /* 增大按钮宽度 */
            height: 40px; /* 增大按钮高度 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation; /* 优化触摸体验 */
        }
        
        .add-category-btn:hover, .category-settings-btn:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        /* 分类列表 - 优化显示效果 */
        .category-list {
            list-style: none;
        }
        
        .category-item {
            padding: 12px 15px;
            margin-bottom: 6px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            position: relative;
            min-height: 44px; /* 确保触摸区域足够大 */
        }
        
        .category-item:hover {
            background-color: rgba(52, 152, 219, 0.08);
            transform: translateX(2px);
        }
        
        .category-item.active {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--primary-color);
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.1);
        }
        
        /* 一级分类和二级分类分开显示 */
        .category-item.level-1 {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
        }
        
        .category-item.level-1.active {
            border-left: 3px solid var(--primary-color);
        }
        
        .category-item.level-2 {
            padding: 10px 15px 10px 30px;
            font-size: 14px;
            margin-bottom: 4px;
            margin-left: 10px;
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .dark-mode .category-item.level-2 {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .category-item.level-2:hover {
            background-color: rgba(52, 152, 219, 0.12);
        }
        
        .category-item.level-2.active {
            background-color: rgba(52, 152, 219, 0.2);
            font-weight: 500;
        }
        
        .category-name {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .category-name .fa-folder, .category-name .fa-folder-open {
            margin-right: 10px;
            font-size: 14px;
            color: var(--primary-color);
        }
        
        .category-item.level-2 .category-name .fa-folder {
            color: var(--text-light);
        }
        
        .category-count {
            color: var(--text-light);
            font-size: 12px;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .dark-mode .category-count {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .category-drag {
            color: var(--text-light);
            margin-right: 8px;
            cursor: move;
        }
        
        /* 新增：折叠图标样式 */
        .collapse-icon {
            color: var(--text-light);
            font-size: 12px;
            margin-left: 8px;
            cursor: pointer;
            width: 28px; /* 增大触摸区域 */
            height: 28px; /* 增大触摸区域 */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: all 0.2s;
            opacity: 0;
        }
        
        .category-item:hover .collapse-icon,
        .category-item.collapsed .collapse-icon {
            opacity: 1;
        }
        
        .collapse-icon:hover {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }
        
        /* 分类设置模式下的按钮 */
        .category-edit-btns {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .category-item:hover .category-edit-btns {
            opacity: 1;
        }
        
        .category-edit-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 12px;
            cursor: pointer;
            width: 30px; /* 增大按钮宽度 */
            height: 30px; /* 增大按钮高度 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation; /* 优化触摸体验 */
        }
        
        .category-edit-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode .category-edit-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 二级分类容器 */
        .subcategory-list {
            list-style: none;
            margin-left: 25px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
            max-height: 500px;
            opacity: 1;
        }
        
        .subcategory-list.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }
        
        /* 右侧内容区 */
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* 批量操作栏 */
        .batch-operations-bar {
            background-color: var(--card-color);
            border-radius: var(--radius);
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: none;
            align-items: center;
            justify-content: space-between;
        }
        
        .batch-operations-bar.active {
            display: flex;
        }
        
        .batch-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .batch-action-btn {
            padding: 12px 18px; /* 增大按钮内边距 */
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 44px; /* 确保触摸区域足够大 */
            touch-action: manipulation; /* 优化触摸体验 */
        }
        
        .batch-action-btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .batch-action-btn.primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .batch-action-btn.secondary {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .batch-action-btn.secondary:hover {
            background-color: rgba(52, 152, 219, 0.05);
            transform: translateY(-2px);
        }
        
        .batch-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .selected-count {
            font-weight: 500;
            color: var(--primary-color);
        }
        
        /* 星标网址栏 */
        .starred-section {
            background-color: var(--card-color);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: none;
        }
        
        .starred-section.has-items {
            display: block;
        }
        
        .starred-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .starred-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            cursor: pointer;
            padding: 10px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            min-height: 90px; /* 确保触摸区域足够大 */
        }
        
        .starred-item:hover {
            background-color: rgba(52, 152, 219, 0.1);
            transform: translateY(-3px);
        }
        
        .starred-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .starred-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: transparent;
        }
        
        .starred-name {
            font-size: 13px;
            text-align: center;
            word-break: break-all;
            max-height: 36px;
            overflow: hidden;
            line-height: 1.3;
        }
        
        /* 网址显示区 */
        .urls-section {
            flex: 1;
        }
        
        .urls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .urls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }
        
        .url-card {
            background-color: var(--card-color);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 1px solid transparent;
            min-height: 140px; /* 确保触摸区域足够大 */
        }
        
        .url-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.15);
            border-color: var(--primary-light);
        }
        
        /* 鼠标划过，鼠标的显示效果改为手指 */
        .url-card, .starred-item {
            cursor: pointer;
        }
        
        /* 修改：图标背景透明，边框透明 */
        .url-icon {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 24px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.1);
            border: 1px solid transparent; /* 边框透明 */
        }
        
        .url-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: transparent;
        }
        
        .url-name {
            font-weight: 500;
            text-align: center;
            word-break: break-word;
            max-height: 42px;
            overflow: hidden;
        }
        
        /* 扩展图标 */
        .url-expand {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px; /* 增大按钮尺寸 */
            height: 32px; /* 增大按钮尺寸 */
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            touch-action: manipulation; /* 优化触摸体验 */
        }
        
        .url-expand i {
            font-size: 12px;
        }
        
        .url-card:hover .url-expand {
            display: flex;
        }
        
        /* 批量操作模式下的网址卡片 */
        .url-card.select-mode {
            cursor: pointer;
            position: relative;
            padding: 15px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .url-checkbox-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2;
        }
        
        .url-checkbox {
            width: 24px; /* 增大复选框尺寸 */
            height: 24px; /* 增大复选框尺寸 */
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        
        /* 星标网址栏在批量模式下的样式 */
        .starred-section.batch-mode .starred-item {
            position: relative;
        }
        
        .starred-section.batch-mode .starred-checkbox {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px; /* 增大复选框尺寸 */
            height: 22px; /* 增大复选框尺寸 */
            cursor: pointer;
            z-index: 2;
            accent-color: var(--primary-color);
        }
        
        /* 表单样式 */
        .form-container {
            background-color: var(--card-color);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .form-container::-webkit-scrollbar-track {
            background: var(--bg-color);
            border-radius: 3px;
        }
        
        .form-container::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }
        
        .form-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        
        .form-title i {
            margin-right: 10px;
        }
        
        .form-row {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
            transition: all 0.2s;
            height: 46px; /* 统一高度 */
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* 网站图标输入框错误状态 */
        .form-input.error {
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        /* 图标预览区域 */
        .icon-preview-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .icon-preview {
            width: 60px;
            height: 44px;
            border-radius: 8px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .icon-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            background-color: transparent;
        }
        
        /* 优化星标、分类选择和网址名称的布局 - 高度统一 */
        .inline-form-row {
            display: flex;
            align-items: center;
            gap: 15px;
            height: 80px; /* 统一高度 */
        }
        
        .star-container {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 100%;
        }
        
        .category-container {
            flex: 0 0 180px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 100%;
        }
        
        .name-container {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 100%;
        }
        
        .star-btn {
            background: none;
            border: none;
            font-size: 32px; /* 增大图标 */
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
            display: block;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px; /* 增大触摸区域 */
            touch-action: manipulation; /* 优化触摸体验 */
        }
        
        .star-btn.active {
            color: #f1c40f;
        }
        
        /* 绑定信息区域优化 */
        .binding-section {
            background-color: var(--bg-color);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-top: 10px;
        }
        
        .binding-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .binding-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            min-height: 24px; /* 确保触摸区域足够大 */
        }
        
        .binding-option input[type="checkbox"] {
            width: 20px; /* 增大复选框尺寸 */
            height: 20px; /* 增大复选框尺寸 */
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        
        .binding-inputs {
            display: none;
        }
        
        .binding-inputs.active {
            display: block;
        }
        
        .binding-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .binding-label {
            min-width: 60px;
            font-weight: 500;
        }
        
        .realname-options {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        
        .realname-option {
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 24px; /* 确保触摸区域足够大 */
        }
        
        .realname-option input[type="radio"] {
            accent-color: var(--primary-color);
            width: 18px; /* 增大单选框尺寸 */
            height: 18px; /* 增大单选框尺寸 */
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 28px; /* 增大按钮内边距 */
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 50px; /* 确保触摸区域足够大 */
            touch-action: manipulation; /* 优化触摸体验 */
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: rgba(52, 152, 219, 0.05);
            transform: translateY(-2px);
        }
        
        /* 功能按钮面板 */
        .functions-panel {
            background-color: var(--card-color);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .functions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .function-item {
            background-color: var(--bg-color);
            border-radius: var(--radius-sm);
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 120px; /* 确保触摸区域足够大 */
        }
        
        .function-item:hover {
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent-color) 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.2);
        }
        
        .function-icon {
            font-size: 32px; /* 增大图标 */
            margin-bottom: 12px;
            color: var(--accent-color);
        }
        
        .function-item:hover .function-icon {
            color: white;
        }
        
        .function-name {
            font-size: 15px; /* 增大字体 */
            font-weight: 500;
            text-align: center;
        }
        
        /* 回收站样式 */
        .recycle-bin {
            display: none;
        }
        
        .recycle-bin.active {
            display: block;
        }
        
        .recycle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background-color: var(--card-color);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            min-height: 80px; /* 确保触摸区域足够大 */
        }
        
        .recycle-item-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .recycle-item-icon {
            width: 50px; /* 增大图标 */
            height: 50px; /* 增大图标 */
            border-radius: 8px;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 18px; /* 增大字体 */
            flex-shrink: 0;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .recycle-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: transparent;
        }
        
        .recycle-item-name {
            font-weight: 500;
            font-size: 16px; /* 增大字体 */
        }
        
        .recycle-item-category {
            font-size: 14px;
            color: var(--text-light);
        }
        
        .recycle-item-actions {
            display: flex;
            gap: 10px;
        }
        
        /* 响应式设计 */
        @media (max-width: 992px) {
            .categories-sidebar {
                width: 220px;
            }
            
            .urls-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .search-container {
                margin: 10px 0 0 0;
                order: 3;
                flex-basis: 100%;
                max-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .categories-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 15px;
                max-height: 250px;
            }
            
            .inline-form-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                height: auto;
            }
            
            .star-container, .category-container, .name-container {
                width: 100%;
            }
            
            .category-container {
                flex: 1;
            }
            
            .urls-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }
            
            .batch-operations-bar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .batch-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            /* 移动端按钮优化 */
            .header-btn, .batch-operations-btn {
                width: 44px;
                height: 44px;
                font-size: 20px; /* 增大图标 */
            }
            
            .btn {
                padding: 12px 20px;
                min-height: 46px;
                font-size: 15px;
            }
            
            .batch-action-btn {
                padding: 10px 15px;
                min-height: 42px;
            }
        }
        
        @media (max-width: 480px) {
            .urls-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
            }
            
            .functions-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .form-container, .functions-panel {
                padding: 15px;
            }
            
            .header-buttons {
                gap: 5px;
            }
            
            .header-btn, .batch-operations-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .batch-action-btn {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
        
        /* 工具类 */
        .hidden {
            display: none !important;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .drag-over {
            border: 2px dashed var(--primary-color) !important;
            background-color: rgba(52, 152, 219, 0.05) !important;
        }
        
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        
        /* 模态框样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background-color: var(--card-color);
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--text-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px; /* 增大关闭按钮 */
            color: var(--text-light);
            cursor: pointer;
            width: 36px; /* 增大触摸区域 */
            height: 36px; /* 增大触摸区域 */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            touch-action: manipulation; /* 优化触摸体验 */
        }
        
        .close-modal:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        /* 消息提示 */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: var(--shadow);
            z-index: 1001;
            min-width: 200px;
            text-align: center;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.success {
            background-color: #2ecc71;
        }
        
        .toast.error {
            background-color: #e74c3c;
        }
        
        .toast.warning {
            background-color: #f39c12;
        }
        
        .toast.info {
            background-color: #3498db;
        }
        
        /* 拖拽排序样式 */
        .sortable-ghost {
            opacity: 0.4;
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .sortable-chosen {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
        }
        
        .url-card.sortable-item {
            cursor: move;
        }
        
        /* 分类设置模式 */
        .category-item.setting-mode {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .category-item.setting-mode .category-drag {
            opacity: 1;
        }
        
        /* 分类设置模式下的按钮布局优化 */
        .category-item.setting-mode .category-edit-btns {
            opacity: 1;
            display: flex;
            align-items: center;
        }
        
        /* 确保分类设置模式下按钮不重叠 */
        .category-item.setting-mode .category-name {
            flex: 0 1 auto;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .category-item.setting-mode .category-count {
            margin-left: auto;
            margin-right: 10px;
        }
        
        /* 分类设置模式下隐藏折叠图标 */
        .category-item.setting-mode .collapse-icon {
            display: none !important;
        }
        
        /* 新增：分类输入提示 */
        .category-suggestions {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* 便签面板样式 */
        .notes-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--card-color) 100%);
            border-radius: var(--radius);
            overflow: hidden;
        }

        /* 便签头部样式 */
        .notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card-color);
            padding: 18px 28px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .notes-logo-container {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .notes-logo {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
        }

        .notes-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-color);
            letter-spacing: -0.3px;
        }

        .new-note-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 26px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.25s ease;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            min-height: 46px; /* 确保触摸区域足够大 */
            touch-action: manipulation; /* 优化触摸体验 */
        }

        .new-note-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(52, 152, 219, 0.3);
        }

        .new-note-btn:active {
            transform: translateY(0);
        }

        /* 便签视图切换按钮 */
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 15px;
        }

        .view-toggle-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 10px 18px; /* 增大按钮内边距 */
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 40px; /* 确保触摸区域足够大 */
            touch-action: manipulation; /* 优化触摸体验 */
        }

        .view-toggle-btn:hover {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .view-toggle-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 便签网格布局 - 自适应 */
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 28px;
            padding: 10px;
            flex: 1;
            overflow-y: auto;
        }

        /* 便签列表布局 */
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
            flex: 1;
            overflow-y: auto;
        }

        /* 便签卡片样式 */
        .note-card {
            background: var(--card-color);
            border-radius: 16px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid var(--border-color);
        }

        /* 网格视图下的卡片 */
        .notes-grid .note-card {
            height: 360px;
        }

        /* 列表视图下的卡片 */
        .notes-list .note-card {
            flex-direction: row;
            height: auto;
            min-height: 120px;
            max-height: 200px;
        }

        .notes-list .note-content {
            flex: 1;
            min-height: 120px;
            max-height: 200px;
            border-right: 1px solid var(--border-color);
        }

        .notes-list .note-info {
            display: flex;
            flex-direction: column;
            width: 200px;
            padding: 15px;
            background: var(--bg-color);
        }

        .notes-list .char-counter {
            padding: 6px 0;
            font-size: 13px;
            color: var(--text-light);
            text-align: left;
            background: transparent;
            border-top: none;
            margin-top: auto;
        }

        .notes-list .note-footer {
            padding: 10px 0 0 0;
            background: transparent;
            border-top: none;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .notes-list .note-actions {
            gap: 12px;
        }

        .note-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-light);
        }

        .note-content {
            flex-grow: 1;
            padding: 22px;
            overflow-y: auto;
            line-height: 1.65;
            font-size: 16px;
            color: var(--text-color);
            background: var(--card-color);
            border: none;
            resize: none;
            width: 100%;
            font-family: inherit;
        }

        .note-content:focus {
            outline: none;
            background: var(--bg-color);
        }

        /* 自定义滚动条 */
        .note-content::-webkit-scrollbar {
            width: 6px;
        }

        .note-content::-webkit-scrollbar-track {
            background: var(--bg-color);
            border-radius: 10px;
        }

        .note-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }

        .note-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        /* 字符计数器 */
        .char-counter {
            padding: 6px 22px;
            font-size: 13px;
            color: var(--text-light);
            text-align: right;
            background: var(--bg-color);
            border-top: 1px solid var(--border-color);
        }

        /* 底部操作栏 */
        .note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 22px;
            background: var(--bg-color);
            border-top: 1px solid var(--border-color);
        }

        .note-date {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 500;
            white-space: nowrap;
        }

        .note-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        /* 默认按钮样式（带文字） */
        .note-action-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 5px 0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
            white-space: nowrap;
            min-height: 30px; /* 确保触摸区域足够大 */
            touch-action: manipulation; /* 优化触摸体验 */
        }

        .note-action-btn:hover {
            color: var(--primary-color);
        }

        .note-action-btn:hover::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--primary-color);
        }

        .note-copy-btn:hover {
            color: #10b981;
        }

        .note-copy-btn:hover::after {
            background: #10b981;
        }

        .note-export-btn:hover {
            color: #3b82f6;
        }

        .note-export-btn:hover::after {
            background: #3b82f6;
        }

        .note-delete-btn:hover {
            color: #ef4444;
        }

        .note-delete-btn:hover::after {
            background: #ef4444;
        }

        .note-action-btn i {
            font-size: 12px;
        }

        /* 空状态提示 */
        .notes-empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .notes-empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: var(--border-color);
            opacity: 0.7;
        }

        .notes-empty-state h3 {
            font-size: 22px;
            margin-bottom: 12px;
            color: var(--text-color);
            font-weight: 600;
        }

        .notes-empty-state p {
            font-size: 15px;
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.6;
            color: var(--text-light);
        }

        /* 选中状态 */
        .note-card.selected {
            border-color: var(--primary-color);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        /* 字符数多时的提示 */
        .char-counter.large-count {
            color: #f39c12;
            font-weight: 600;
        }

        /* 便签内容占位符样式 */
        .note-content::placeholder {
            color: var(--text-light);
            font-style: italic;
        }

        /* 响应式设计 - 便签 */
        @media (max-width: 1199px) and (min-width: 900px) {
            .notes-grid {
                grid-template-columns: repeat(3, minmax(300px, 1fr));
            }
        }

        @media (max-width: 899px) and (min-width: 600px) {
            .notes-grid {
                grid-template-columns: repeat(2, minmax(280px, 1fr));
            }
            
            .notes-list .note-info {
                width: 150px;
            }
        }

        @media (max-width: 599px) {
            .notes-grid {
                grid-template-columns: 1fr;
            }
            
            .notes-list .note-card {
                flex-direction: column;
                max-height: none;
            }
            
            .notes-list .note-content {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                min-height: 150px;
            }
            
            .notes-list .note-info {
                width: 100%;
            }
            
            .notes-header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .view-toggle {
                margin-right: 0;
            }
        }

        /* 针对小屏幕的按钮优化 - 只显示图标 */
        @media (max-width: 768px) {
            .notes-list .note-action-btn span {
                display: none;
            }
            
            .notes-list .note-action-btn {
                width: 36px; /* 增大按钮尺寸 */
                height: 36px; /* 增大按钮尺寸 */
                border-radius: 8px;
                background: var(--bg-color);
                justify-content: center;
                padding: 0;
            }
            
            .notes-list .note-action-btn i {
                font-size: 16px; /* 增大图标 */
                margin: 0;
            }
            
            .notes-list .note-action-btn:hover::after {
                display: none;
            }
            
            .notes-list .note-actions {
                gap: 8px;
            }
            
            .new-note-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .view-toggle-btn {
                padding: 8px 14px;
                font-size: 13px;
            }
        }
        
        /* 日志条目样式 */
        .log-item {
            margin-bottom: 8px;
            padding: 10px;
            border-radius: var(--radius-sm);
            background-color: var(--card-color);
            border-left: 4px solid var(--primary-color);
            transition: all 0.2s;
        }

        .log-item:hover {
            transform: translateX(2px);
            box-shadow: var(--shadow);
        }

        /* 同步按钮在线/离线状态 */
        #gistSyncBtn.online {
            color: var(--accent-color);
        }

        #gistSyncBtn.offline {
            color: #e74c3c;
        }

        /* Token状态指示器 */
        .token-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .token-status.valid {
            background-color: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }

        .token-status.invalid {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        /* 同步状态指示器 */
        .sync-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .sync-status-indicator.syncing {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* 新增：子网址样式 */
        .sub-urls-container {
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 15px;
            background-color: var(--bg-color);
        }
        
        .sub-url-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sub-url-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .sub-url-name-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-color);
            color: var(--text-color);
        }
        
        .sub-url-input {
            flex: 2;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-color);
            color: var(--text-color);
        }
        
        .sub-url-delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-sub-url-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-top: 10px;
        }
        
        .add-sub-url-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .url-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .copy-url-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 46px;
            height: 46px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }
        
        .copy-url-btn:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        /* 详情模态框中的子网址样式 - 优化布局 */
        .sub-url-detail {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }
        
        .sub-url-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
        }
        
        .sub-url-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .sub-url-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sub-url-name {
            font-weight: 500;
            min-width: 80px;
        }
        
        .sub-url-url {
            font-size: 13px;
            color: var(--text-light);
            word-break: break-all;
            flex: 1;
        }
        
        .sub-url-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .sub-url-action-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .sub-url-action-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .detail-row {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-row strong {
            min-width: 80px;
        }
        
        .detail-row span {
            flex: 1;
            word-break: break-all;
        }
        
        .detail-row .copy-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.2s;
        }
        
        .detail-row .copy-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* 网址详情标题栏按钮样式 */
        .detail-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }
        
        .detail-header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .detail-header-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .detail-header-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .detail-header-btn.secondary {
            background: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .detail-header-btn.secondary:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .detail-modal-body {
            padding: 20px;
        }
        
        .detail-modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            text-align: right;
        }

        /* 密码显示/隐藏按钮样式 */
        .password-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.2s;
        }
        
        .password-toggle:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* 详情部分标题样式 */
        .detail-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin: 25px 0 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .detail-section-title:first-child {
            margin-top: 0;
        }
        
        .detail-section-title .toggle-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid var(--primary-color);
        }
        
        .detail-section-title .toggle-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* 绑定信息行样式 */
        .binding-info-row {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .binding-info-row:last-child {
            border-bottom: none;
        }
        
        .binding-info-label {
            font-weight: 500;
            min-width: 80px;
            color: var(--text-color);
        }
        
        .binding-info-value {
            flex: 1;
            color: var(--text-light);
            word-break: break-all;
        }
        
        /* 数据中心样式 */
        .data-center-panel {
            background-color: var(--card-color);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .data-center-cards {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .data-center-card {
            background-color: var(--bg-color);
            border-radius: var(--radius-sm);
            padding: 25px;
            border: 1px solid var(--border-color);
        }
        
        .data-center-card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .data-center-card-title .title-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-center-card-title .title-right {
            font-size: 14px;
            color: var(--text-light);
        }
        
        .sync-status-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sync-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .sync-status-indicator.online {
            background-color: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }
        
        .sync-status-indicator.offline {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }
        
        .sync-actions-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .sync-actions-left {
            display: flex;
            gap: 10px;
        }
        
        .sync-actions-right {
            margin-left: auto;
        }
        
        .sync-interval-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sync-interval-label {
            font-weight: 500;
            color: var(--text-color);
        }
        
        .import-file-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .import-file-input {
            flex: 1;
        }
        
        .import-file-btn {
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .export-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .export-main-btn {
            width: 100%;
        }
        
        .export-description {
            text-align: center;
            color: var(--text-light);
            margin: 10px 0 20px 0;
        }
        
        .export-content-list {
            padding-left: 20px;
            color: var(--text-light);
            margin-top: 15px;
        }
        
        .export-content-list li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Token登录界面 -->
    <div id="tokenOverlay">
        <div class="token-box">
            <h3>请先连接您的数据库</h3>
            <p>如果没有Token，请先在GitHub生成一个具有`gist`权限的Token。</small></p>
            <input type="password" id="githubTokenInput" placeholder="在此粘贴你的Token">
            <div style="margin-top: 20px;">
                <button onclick="connectToGist()">开始连接</button>
            </div>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div class="container">
        <!-- 页头 -->
        <header>
            <div class="logo-container" onclick="window.app.showUrlsView()">
                <div class="logo-text">SPAN</div>
                <div class="logo-subtext">网址收藏</div>
            </div>
            
            <!-- 搜索容器 -->
            <div class="search-container">
                <div class="search-icon">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" class="search-box" id="searchBox" placeholder="搜索收藏或输入关键词进行搜索">
                <button class="local-search-btn" id="localSearchBtn" title="本地搜索">
                    <i class="fas fa-bookmark"></i>
                </button>
            </div>
            
            <!-- 功能按钮区 - 已移除Gist同步按钮 -->
            <div class="header-buttons">
                <!-- 修改1：新增网址图标变更为手指点击形态 -->
                <button class="header-btn" id="addUrlBtn" title="新增网址">
                    <i class="fas fa-hand-pointer"></i>
                </button>
                <button class="header-btn" id="notesBtn" title="便签">
                    <i class="fas fa-sticky-note"></i>
                </button>
                <button class="header-btn" id="functionsBtn" title="全部功能">
                    <i class="fas fa-leaf"></i>
                </button>
                <button class="header-btn" id="sortBtn" title="网址排序">
                    <i class="fas fa-lock"></i>
                </button>
                <!-- 已移除：Gist同步按钮 -->
                <!-- 批量操作按钮 -->
                <button class="batch-operations-btn" id="batchOperationsBtn" title="批量操作">
                    <i class="fas fa-check-square"></i>
                </button>
                <button class="header-btn" id="themeBtn" title="切换主题">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>
        
        <!-- 主体内容 -->
        <div class="main-content">
            <!-- 左侧分类区 -->
            <div class="categories-sidebar">
                <div class="categories-header">
                    <div class="categories-title-row">
                        <h2 class="categories-title">分类</h2>
                        <div class="category-actions">
                            <button class="add-category-btn" id="addCategoryBtn" title="新增分类">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="category-settings-btn" id="categorySettingsBtn" title="分类设置">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <ul class="category-list" id="categoryList">
                    <!-- 分类将通过JavaScript动态生成 -->
                </ul>
            </div>
            
            <!-- 右侧内容区 -->
            <div class="content-area">
                <!-- 批量操作栏 -->
                <div class="batch-operations-bar" id="batchOperationsBar">
                    <div class="batch-actions">
                        <button class="batch-action-btn secondary" id="batchSelectAllBtn">
                            <i class="fas fa-check-square"></i> 全选
                        </button>
                        <button class="batch-action-btn secondary" id="batchDeleteBtn" disabled>
                            <i class="fas fa-trash"></i> 删除
                        </button>
                        <button class="batch-action-btn secondary" id="batchMoveBtn" disabled>
                            <i class="fas fa-folder"></i> 移动
                        </button>
                        <span class="selected-count" id="selectedCount">已选择 0 个网址</span>
                    </div>
                    <button class="batch-action-btn secondary" id="cancelBatchBtn">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
                
                <!-- 星标网址栏 -->
                <div class="starred-section" id="starredSection">
                    <div class="starred-items" id="starredItems">
                        <!-- 星标网址将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 网址显示区 -->
                <div class="urls-section" id="urlsSection">
                    <div class="urls-header">
                        <h2 class="section-title" id="sectionTitle">全部网址</h2>
                    </div>
                    
                    <div class="urls-grid" id="urlsGrid">
                        <!-- 网址卡片将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 便签面板 -->
                <div class="notes-panel hidden" id="notesPanel">
                    <!-- 便签头部 -->
                    <div class="notes-header">
                        <div class="notes-logo-container">
                            <div class="notes-logo">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <h1 class="notes-title">便签</h1>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div class="view-toggle">
                                <button class="view-toggle-btn active" id="gridViewBtn" title="网格视图">
                                    <i class="fas fa-th-large"></i> 网格
                                </button>
                                <button class="view-toggle-btn" id="listViewBtn" title="列表视图">
                                    <i class="fas fa-list"></i> 列表
                                </button>
                            </div>
                            <button id="newNoteBtn" class="new-note-btn">
                                <i class="fas fa-plus"></i>
                                新建便签
                            </button>
                        </div>
                    </div>
                    
                    <!-- 便签网格视图 -->
                    <div class="notes-grid" id="notesGrid">
                        <!-- 便签卡片将通过JavaScript动态生成 -->
                        <div class="notes-empty-state" id="notesEmptyState">
                            <div class="notes-empty-icon">
                                <i class="fas fa-clipboard"></i>
                            </div>
                            <h3>还没有任何便签</h3>
                            <p>点击右上角的"新建便签"按钮创建您的第一个便签。您可以输入任意长度的内容，系统会自动保存您的便签。</p>
                        </div>
                    </div>
                    
                    <!-- 便签列表视图 -->
                    <div class="notes-list hidden" id="notesList">
                        <!-- 列表视图的便签将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 新增网址表单 -->
                <div class="form-container hidden" id="addUrlForm">
                    <!-- 修改2：表单标题图标变更为编辑形态的图标 -->
                    <h2 class="form-title"><i class="fas fa-edit"></i> <span id="formActionTitle">新增网址</span></h2>
                    
                    <div class="form-row">
                        <label class="form-label" for="url">网址信息</label>
                        <!-- 修改3：网址输入框后新增+号按钮 -->
                        <div class="url-input-group">
                            <input type="url" class="form-input" id="url" placeholder="https://example.com" style="flex: 1;">
                            <button class="copy-url-btn" id="addSubUrlBtn" title="添加子网址" type="button">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 修改3：子网址容器 -->
                    <div class="sub-urls-container hidden" id="subUrlsContainer">
                        <div id="subUrlsList">
                            <!-- 子网址行将通过JavaScript动态生成 -->
                        </div>
                        <button type="button" class="add-sub-url-btn" id="addAnotherSubUrlBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <!-- 优化布局：星标、分类选择、网址名称在一行 -->
                    <div class="form-row inline-form-row">
                        <div class="star-container">
                            <label class="form-label">星标</label>
                            <button class="star-btn" id="starToggle" title="星标">
                                <i class="far fa-star"></i>
                            </button>
                        </div>
                        <div class="category-container">
                            <label class="form-label" for="category">分类选择</label>
                            <input type="text" class="form-input" id="category" list="categoryListOptions" placeholder="输入或选择分类">
                            <datalist id="categoryListOptions">
                                <!-- 分类选项将通过JavaScript动态生成 -->
                            </datalist>
                        </div>
                        <div class="name-container">
                            <label class="form-label" for="name">网址名称</label>
                            <input type="text" class="form-input" id="name" placeholder="输入网址名称">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label class="form-label" for="iconUrl">网站图标 (可选)</label>
                        <input type="url" class="form-input" id="iconUrl" placeholder="图标URL链接">
                        <div class="icon-preview-container">
                            <div class="icon-preview" id="iconPreview">
                                <span style="color: var(--text-light); font-size: 12px;">图标预览</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
                                输入URL后自动预览，链接错误时文字会变红。
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="inline-form-row">
                            <div style="flex: 1;">
                                <label class="form-label" for="account">账号 (可选)</label>
                                <input type="text" class="form-input" id="account" placeholder="网站账号">
                            </div>
                            <div style="flex: 1;">
                                <label class="form-label" for="password">密码 (可选)</label>
                                <input type="password" class="form-input" id="password" placeholder="网站密码">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 绑定信息区域 -->
                    <div class="form-row">
                        <label class="form-label">绑定信息 (可选)</label>
                        <div class="binding-section">
                            <div class="binding-options">
                                <label class="binding-option">
                                    <input type="checkbox" id="bindPhone" name="binding" value="phone">
                                    手机
                                </label>
                                <label class="binding-option">
                                    <input type="checkbox" id="bindEmail" name="binding" value="email">
                                    邮箱
                                </label>
                                <label class="binding-option">
                                    <input type="checkbox" id="bindWechat" name="binding" value="wechat">
                                    微信
                                </label>
                                <label class="binding-option">
                                    <input type="checkbox" id="bindQQ" name="binding" value="qq">
                                    QQ
                                </label>
                                <label class="binding-option">
                                    <input type="checkbox" id="bindRealname" name="binding" value="realname">
                                    实名
                                </label>
                                <label class="binding-option">
                                    <input type="checkbox" id="bindOther" name="binding" value="other">
                                    其他
                                </label>
                            </div>
                            
                            <!-- 绑定信息输入区域 -->
                            <div id="bindingInputs">
                                <!-- 手机输入 -->
                                <div class="binding-inputs" id="phoneInputs">
                                    <div class="binding-input-row">
                                        <span class="binding-label">手机号:</span>
                                        <input type="text" class="form-input" id="phoneValue" placeholder="请输入手机号" style="flex: 1;">
                                    </div>
                                </div>
                                
                                <!-- 邮箱输入 -->
                                <div class="binding-inputs" id="emailInputs">
                                    <div class="binding-input-row">
                                        <span class="binding-label">邮箱:</span>
                                        <input type="email" class="form-input" id="emailValue" placeholder="请输入邮箱" style="flex: 1;">
                                    </div>
                                </div>
                                
                                <!-- 微信输入 -->
                                <div class="binding-inputs" id="wechatInputs">
                                    <div class="binding-input-row">
                                        <span class="binding-label">微信号:</span>
                                        <input type="text" class="form-input" id="wechatValue" placeholder="请输入微信号" style="flex: 1;">
                                    </div>
                                </div>
                                
                                <!-- QQ输入 -->
                                <div class="binding-inputs" id="qqInputs">
                                    <div class="binding-input-row">
                                        <span class="binding-label">QQ号:</span>
                                        <input type="text" class="form-input" id="qqValue" placeholder="请输入QQ号" style="flex: 1;">
                                    </div>
                                </div>
                                
                                <!-- 实名输入 -->
                                <div class="binding-inputs" id="realnameInputs">
                                    <div class="binding-input-row">
                                        <span class="binding-label">实名状态:</span>
                                        <div class="realname-options">
                                            <label class="realname-option">
                                                <input type="radio" name="realnameStatus" value="verified" checked>
                                                已实名
                                            </label>
                                            <label class="realname-option">
                                                <input type="radio" name="realnameStatus" value="unverified">
                                                未实名
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 其他输入 -->
                                <div class="binding-inputs" id="otherInputs">
                                    <div class="binding-input-row">
                                        <span class="binding-label">其他:</span>
                                        <input type="text" class="form-input" id="otherValue" placeholder="请输入其他绑定信息" style="flex: 1;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <label class="form-label" for="description">网址描述 (可选)</label>
                        <!-- 将高度从3行增加到6行 -->
                        <textarea class="form-input" id="description" rows="6" placeholder="输入网址描述"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="cancelAddBtn">取消</button>
                        <button class="btn btn-primary" id="saveUrlBtn">保存网址</button>
                    </div>
                </div>
                
                <!-- 功能按钮面板 -->
                <div class="functions-panel hidden" id="functionsPanel">
                    <h2 class="form-title"><i class="fas fa-leaf"></i> 全部功能</h2>
                    
                    <div class="functions-grid">
                        <!-- 按照指定顺序重新排序：便签、图标库、数据中心、操作日志、回收站 -->
                        <div class="function-item" data-function="notes">
                            <div class="function-icon">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <div class="function-name">便签</div>
                        </div>
                        <div class="function-item" data-function="icons">
                            <div class="function-icon">
                                <i class="fas fa-icons"></i>
                            </div>
                            <div class="function-name">图标库</div>
                        </div>
                        <div class="function-item" data-function="datacenter">
                            <div class="function-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="function-name">数据中心</div>
                        </div>
                        <div class="function-item" data-function="logs">
                            <div class="function-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="function-name">操作日志</div>
                        </div>
                        <div class="function-item" data-function="recycle">
                            <div class="function-icon">
                                <i class="fas fa-trash-restore"></i>
                            </div>
                            <div class="function-name">回收站</div>
                        </div>
                    </div>
                </div>
                
                <!-- 数据中心面板 -->
                <div class="data-center-panel hidden" id="dataCenterPanel">
                    <h2 class="form-title"><i class="fas fa-database"></i> 数据中心</h2>
                    
                    <div class="data-center-cards">
                        <!-- 卡片一：Gist同步 -->
                        <div class="data-center-card">
                            <div class="data-center-card-title">
                                <div class="title-left">
                                    <span>Gist同步设置</span>
                                    <span id="syncStatusIndicator" class="sync-status-indicator online">
                                        <i class="fas fa-wifi"></i> 在线
                                    </span>
                                </div>
                                <div class="title-right" id="lastSyncTime">
                                    从未同步
                                </div>
                            </div>
                            
                            <!-- 第二排：立即同步按钮和间隔时间 -->
                            <div class="sync-actions-row">
                                <div class="sync-actions-left">
                                    <button class="btn btn-primary" id="syncNowBtn">
                                        立即同步
                                    </button>
                                </div>
                                <div class="sync-actions-right">
                                    <div class="sync-interval-group">
                                        <span class="sync-interval-label">间隔时间：</span>
                                        <select class="form-select" id="syncInterval" style="width: 120px;">
                                            <option value="0">关闭</option>
                                            <option value="5">5分钟</option>
                                            <option value="15" selected>15分钟</option>
                                            <option value="30">30分钟</option>
                                            <option value="60">1小时</option>
                                            <option value="300">5小时</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 第三排：云端下载按钮 -->
                            <div class="sync-actions-row">
                                <div class="sync-actions-left">
                                    <button class="btn btn-primary" id="pullFromGistBtn">
                                        云端下载
                                    </button>
                                </div>
                                <div class="sync-actions-right">
                                    <!-- 间隔时间选择占两排，这里为空 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 卡片二：Token设置 -->
                        <div class="data-center-card">
                            <div class="data-center-card-title">
                                <span>Token设置</span>
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label">当前Token状态</label>
                                <div id="currentTokenStatus" style="padding: 10px; border-radius: var(--radius-sm); background: var(--bg-color); margin-bottom: 15px;">
                                    <span>检测中...</span>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label">GitHub Personal Access Token</label>
                                <input type="password" class="form-input" id="newTokenInput" placeholder="输入新的Token">
                                <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
                                    需要具有gist权限的Token，用于私有Gist数据存储
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <label class="form-label">操作</label>
                                <div class="form-actions" style="justify-content: flex-start;">
                                    <button class="btn btn-primary" id="testTokenBtn">测试Token</button>
                                    <button class="btn btn-secondary" id="updateTokenBtn">更新Token</button>
                                    <button class="btn btn-secondary" id="clearTokenBtn">清除Token</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 卡片三：数据导入 -->
                        <div class="data-center-card">
                            <div class="data-center-card-title">
                                <span>数据导入</span>
                            </div>
                            
                            <div class="form-row">
                                <p>请选择要导入的数据文件（JSON格式）：</p>
                                <div class="import-file-group">
                                    <input type="file" id="importFile" accept=".json" class="form-input import-file-input">
                                    <button class="btn btn-primary import-file-btn" id="importBtn">导入文件</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 卡片四：数据导出 -->
                        <div class="data-center-card">
                            <div class="data-center-card-title">
                                <span>数据导出</span>
                            </div>
                            
                            <div class="export-actions">
                                <button class="btn btn-primary export-main-btn" id="exportBtn">导出数据</button>
                                <div class="export-description">
                                    点击上方按钮导出您的数据
                                </div>
                            </div>
                            
                            <div>
                                <p><strong>导出内容：</strong></p>
                                <ul class="export-content-list">
                                    <li>所有网址收藏（包括星标、分类、绑定信息等）</li>
                                    <li>所有便签内容</li>
                                    <li>分类信息（包括多级分类结构）</li>
                                    <li>用户设置（主题、排序、视图模式等）</li>
                                    <li>回收站中的项目</li>
                                    <li>所有元数据（创建时间、更新时间等）</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="backFromDataCenterBtn">返回</button>
                    </div>
                </div>
                
                <!-- 回收站面板 -->
                <div class="functions-panel hidden recycle-bin" id="recycleBinPanel">
                    <h2 class="form-title"><i class="fas fa-trash-restore"></i> 回收站</h2>
                    <div class="recycle-items" id="recycleItems">
                        <!-- 回收站内容将通过JavaScript动态生成 -->
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="emptyRecycleBtn">清空回收站</button>
                        <button class="btn btn-secondary" id="backFromRecycleBtn">返回</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 分类管理模态框 -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="categoryModalTitle">新增分类</h3>
                <button class="close-modal" id="closeCategoryModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label class="form-label" for="categoryName">分类名称</label>
                    <input type="text" class="form-input" id="categoryName" placeholder="请输入分类名称">
                </div>
                <div class="form-row">
                    <label class="form-label" for="parentCategory">父级分类 (可选)</label>
                    <select class="form-select" id="parentCategory">
                        <option value="">无 (一级分类)</option>
                        <!-- 一级分类选项将通过JavaScript动态生成 -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCategoryBtn">取消</button>
                <button class="btn btn-primary" id="saveCategoryBtn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 操作日志模态框 -->
    <div class="modal-overlay" id="logsModal">
        <div class="modal" style="max-width: 700px; max-height: 80vh;">
            <div class="modal-header">
                <h3>操作日志</h3>
                <button class="close-modal" id="closeLogsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="logs-actions" style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" id="clearLogsBtn">清空日志</button>
                    <span style="margin-left: 15px; color: var(--text-light); font-size: 14px;">
                        最多保留100条记录
                    </span>
                </div>
                <div class="logs-container" id="logsContainer" 
                     style="max-height: 400px; overflow-y: auto; padding: 10px; background: var(--bg-color); border-radius: var(--radius-sm);">
                    <!-- 日志将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 消息提示 -->
    <div class="toast" id="toast"></div>
    
    <!-- 修复：使用更可靠的CDN链接 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // === Gist 数据存储功能 ===
        let userGistId = null; // 用于存储你的专属Gist ID
        let syncTimer = null; // 定时同步计时器
        let isOnline = navigator.onLine; // 网络状态
        let operationLogs = []; // 操作日志
        let lastSyncTime = null; // 上次同步时间
        
        // 网络状态监听
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncStatus();
            // 网络恢复后立即同步
            if (window.app && window.app.syncToGist) {
                setTimeout(() => window.app.syncToGist(), 1000);
            }
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus();
        });
        
        // 更新同步状态显示
        function updateSyncStatus() {
            const indicator = document.getElementById('syncStatusIndicator');
            if (indicator) {
                if (isOnline) {
                    indicator.innerHTML = '<i class="fas fa-wifi"></i> 在线';
                    indicator.className = 'sync-status-indicator online';
                } else {
                    indicator.innerHTML = '<i class="fas fa-wifi-slash"></i> 离线';
                    indicator.className = 'sync-status-indicator offline';
                }
            }
        }
        
        // 添加操作日志
        function addLog(action, details = '', type = 'info') {
            const log = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                type: type
            };
            
            operationLogs.unshift(log); // 添加到开头
            
            // 保持最多100条记录
            if (operationLogs.length > 100) {
                operationLogs = operationLogs.slice(0, 100);
            }
            
            // 保存到本地存储
            localStorage.setItem('span_operation_logs', JSON.stringify(operationLogs));
            
            // 如果日志模态框是打开的，更新显示
            if (document.getElementById('logsModal')?.classList.contains('active')) {
                window.app?.renderLogs();
            }
        }
        
        // 加载操作日志
        function loadLogs() {
            const savedLogs = localStorage.getItem('span_operation_logs');
            if (savedLogs) {
                try {
                    operationLogs = JSON.parse(savedLogs);
                } catch (e) {
                    console.error('加载操作日志失败:', e);
                    operationLogs = [];
                }
            }
        }
        
        // 格式化日志时间
        function formatLogTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }
        
        // 修复：独立的showToast函数，不依赖app对象
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.className = 'toast';
            toast.classList.add(type);
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 修复：优化connectToGist函数
        async function connectToGist() {
            const token = document.getElementById('githubTokenInput').value.trim();
            if (!token) { 
                showToast('请输入GitHub Personal Access Token', 'error'); 
                return; 
            }

            window.userToken = token; // 保存到全局变量
            localStorage.setItem('github_token', token); // 本地缓存

            try {
                showToast('正在验证Token...', 'info');
                
                // 测试Token有效性
                let testResponse = null;
                let tokenValid = false;
                
                // 尝试使用Bearer和token两种格式
                const authMethods = [
                    { prefix: 'Bearer', url: 'https://api.github.com/user' },
                    { prefix: 'token', url: 'https://api.github.com/user' }
                ];
                
                for (const method of authMethods) {
                    try {
                        const response = await fetch(method.url, {
                            headers: { 
                                'Authorization': `${method.prefix} ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (response.ok) {
                            testResponse = response;
                            tokenValid = true;
                            break;
                        }
                    } catch (e) {
                        console.log(`尝试 ${method.prefix} 方式失败:`, e);
                    }
                }
                
                if (!tokenValid) {
                    throw new Error('Token无效，请检查是否正确（需要具有gist权限的Token）');
                }
                
                showToast('Token验证成功，正在连接Gist...', 'info');
                
                // 尝试查找或创建Gist
                let gistsResponse = null;
                let gists = null;
                
                // 尝试两种授权方式获取Gist列表
                for (const prefix of ['Bearer', 'token']) {
                    try {
                        gistsResponse = await fetch('https://api.github.com/gists', {
                            headers: { 
                                'Authorization': `${prefix} ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (gistsResponse.ok) {
                            gists = await gistsResponse.json();
                            break;
                        }
                    } catch (e) {
                        console.log(`尝试 ${prefix} 方式获取Gist列表失败:`, e);
                    }
                }
                
                if (!gists) {
                    throw new Error('无法获取Gist列表，请检查Token权限');
                }
                
                // 寻找我们专用的Gist（通过描述识别）
                let spanGist = gists.find(g => g.description === 'SPAN_BOOKMARKS_DATA_STORAGE');
                
                if (!spanGist) {
                    showToast('正在创建新的Gist仓库...', 'info');
                    
                    // 没有则创建一个新的私有Gist
                    let createResponse = null;
                    for (const prefix of ['Bearer', 'token']) {
                        try {
                            createResponse = await fetch('https://api.github.com/gists', {
                                method: 'POST',
                                headers: { 
                                    'Authorization': `${prefix} ${token}`,
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/vnd.github.v3+json'
                                },
                                body: JSON.stringify({
                                    description: 'SPAN_BOOKMARKS_DATA_STORAGE',
                                    public: false, // 关键：设为私有
                                    files: { 
                                        'data.json': { 
                                            content: JSON.stringify({ 
                                                urls: [], 
                                                notes: [], 
                                                categories: [
                                                    { id: "all", name: "全部", parentId: null, order: 0, level: 0, expanded: true }
                                                ], 
                                                settings: {
                                                    darkMode: false,
                                                    sortingEnabled: false,
                                                    allCategoriesExpanded: true,
                                                    lastSelectedCategory: 'all',
                                                    noteView: 'grid',
                                                    syncInterval: 15,
                                                    autoSync: true
                                                },
                                                logs: []
                                            }, null, 2) 
                                        } 
                                    }
                                })
                            });
                            
                            if (createResponse.ok) {
                                spanGist = await createResponse.json();
                                break;
                            }
                        } catch (e) {
                            console.log(`尝试 ${prefix} 方式创建Gist失败:`, e);
                        }
                    }
                    
                    if (!spanGist) {
                        throw new Error('创建Gist失败，请检查Token权限');
                    }
                }
                
                userGistId = spanGist.id;
                localStorage.setItem('user_gist_id', spanGist.id);
                localStorage.setItem('last_sync_time', new Date().toISOString());

                // 隐藏登录界面，显示主应用
                document.getElementById('tokenOverlay').style.display = 'none';
                document.querySelector('.container').style.display = 'flex';
                
                // 等待页面加载完成后初始化app
                setTimeout(() => {
                    if (window.app && window.app.init) {
                        window.app.init();
                    } else {
                        // 如果app对象不存在，重新加载页面
                        location.reload();
                    }
                }, 100);
                
                addLog('Gist连接', '成功连接到GitHub Gist', 'success');
                showToast('数据仓库连接成功！', 'success');
                
            } catch (error) {
                console.error('连接失败:', error);
                addLog('Gist连接', '连接失败: ' + error.message, 'error');
                showToast('连接失败: ' + error.message + '\n\n请确保：\n1. Token具有gist权限\n2. Token未过期\n3. 网络连接正常', 'error');
                
                // 清空无效的Token
                localStorage.removeItem('github_token');
                localStorage.removeItem('user_gist_id');
                window.userToken = null;
                userGistId = null;
            }
        }

        // 修复：检查本地是否已有Token
        function checkTokenAndInitialize() {
            const savedToken = localStorage.getItem('github_token');
            const savedGistId = localStorage.getItem('user_gist_id');
            
            if (savedToken && savedGistId) {
                // 有保存的Token和Gist ID，隐藏登录框，显示主应用
                document.getElementById('tokenOverlay').style.display = 'none';
                document.querySelector('.container').style.display = 'flex';
                
                // 设置全局变量
                window.userToken = savedToken;
                userGistId = savedGistId;
                
                // 加载操作日志
                loadLogs();
                
                // 等待页面加载完成后初始化app
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        if (window.app && window.app.init) {
                            window.app.init();
                        }
                    });
                } else {
                    setTimeout(() => {
                        if (window.app && window.app.init) {
                            window.app.init();
                        }
                    }, 100);
                }
            } else {
                // 没有Token，显示登录框
                document.getElementById('tokenOverlay').style.display = 'flex';
                document.querySelector('.container').style.display = 'none';
            }
            
            // 初始化网络状态
            updateSyncStatus();
        }

        // 页面加载时检查Token
        checkTokenAndInitialize();
        
        // 创建全局应用对象
        window.app = {
            // 初始化数据
            userData: {
                urls: [],
                notes: [], // 新增便签数据
                categories: [
                    { id: "all", name: "全部", parentId: null, order: 0, level: 0, expanded: true }
                ],
                settings: {
                    darkMode: false,
                    sortingEnabled: false,
                    allCategoriesExpanded: true,
                    lastSelectedCategory: 'all',
                    noteView: 'grid', // 新增：便签视图模式
                    syncInterval: 15, // 同步间隔（分钟）
                    autoSync: true // 自动同步
                }
            },
            
            // 当前状态
            currentState: {
                view: 'urls',
                selectedCategory: 'all',
                selectedUrls: [],
                sortingEnabled: false,
                dataOperation: null,
                categorySettingsMode: false,
                editingCategory: null,
                batchMode: false,
                editingUrl: null,
                currentContext: null,
                // 新增：详情页展开状态
                detailExpanded: {
                    bindings: true,
                    subUrls: true
                }
            },
            
            // DOM元素引用
            elements: {},
            
            // 拖拽排序实例
            sortableInstance: null,
            categorySortableInstance: null,
            subcategorySortableInstances: {},
            
            // 图标测试计时器
            iconTestTimer: null,
            
            // 管理器实例
            notesManager: null,
            
            // 子网址计数器
            subUrlCounter: 0,
            
            // 密码显示定时器
            passwordHideTimer: null,
            
            // 初始化
            init: function() {
                try {
                    this.getElements();
                    this.setupEventListeners();
                    this.loadSettings();
                    
                    // 初始化同步定时器
                    this.initSyncTimer();
                    
                    // 渲染界面
                    this.renderCategories();
                    this.renderUrls();
                    this.updateStarredSection();
                    
                    // 初始化便签管理器
                    this.notesManager = new NotesManager(this);
                    this.notesManager.init();
                    
                    // 更新同步状态显示
                    updateSyncStatus();
                    this.updateLastSyncTime();
                    
                    addLog('应用初始化', '应用启动成功');
                } catch (error) {
                    console.error('应用初始化失败:', error);
                    showToast('应用初始化失败: ' + error.message, 'error');
                }
            },
            
            // 获取DOM元素
            getElements: function() {
                this.elements = {
                    searchBox: document.getElementById('searchBox'),
                    localSearchBtn: document.getElementById('localSearchBtn'),
                    addUrlBtn: document.getElementById('addUrlBtn'),
                    notesBtn: document.getElementById('notesBtn'),
                    sortBtn: document.getElementById('sortBtn'),
                    batchOperationsBtn: document.getElementById('batchOperationsBtn'),
                    themeBtn: document.getElementById('themeBtn'),
                    functionsBtn: document.getElementById('functionsBtn'),
                    addUrlForm: document.getElementById('addUrlForm'),
                    functionsPanel: document.getElementById('functionsPanel'),
                    recycleBinPanel: document.getElementById('recycleBinPanel'),
                    urlsSection: document.getElementById('urlsSection'),
                    starredSection: document.getElementById('starredSection'),
                    starredItems: document.getElementById('starredItems'),
                    urlsGrid: document.getElementById('urlsGrid'),
                    sectionTitle: document.getElementById('sectionTitle'),
                    categoryList: document.getElementById('categoryList'),
                    categoryInput: document.getElementById('category'),
                    categoryListOptions: document.getElementById('categoryListOptions'),
                    starToggle: document.getElementById('starToggle'),
                    cancelAddBtn: document.getElementById('cancelAddBtn'),
                    saveUrlBtn: document.getElementById('saveUrlBtn'),
                    formActionTitle: document.getElementById('formActionTitle'),
                    batchOperationsBar: document.getElementById('batchOperationsBar'),
                    batchSelectAllBtn: document.getElementById('batchSelectAllBtn'),
                    batchDeleteBtn: document.getElementById('batchDeleteBtn'),
                    batchMoveBtn: document.getElementById('batchMoveBtn'),
                    cancelBatchBtn: document.getElementById('cancelBatchBtn'),
                    selectedCount: document.getElementById('selectedCount'),
                    addCategoryBtn: document.getElementById('addCategoryBtn'),
                    categorySettingsBtn: document.getElementById('categorySettingsBtn'),
                    dataCenterPanel: document.getElementById('dataCenterPanel'),
                    syncNowBtn: document.getElementById('syncNowBtn'),
                    pullFromGistBtn: document.getElementById('pullFromGistBtn'),
                    syncInterval: document.getElementById('syncInterval'),
                    currentTokenStatus: document.getElementById('currentTokenStatus'),
                    newTokenInput: document.getElementById('newTokenInput'),
                    testTokenBtn: document.getElementById('testTokenBtn'),
                    updateTokenBtn: document.getElementById('updateTokenBtn'),
                    clearTokenBtn: document.getElementById('clearTokenBtn'),
                    importFile: document.getElementById('importFile'),
                    importBtn: document.getElementById('importBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    backFromDataCenterBtn: document.getElementById('backFromDataCenterBtn'),
                    recycleItems: document.getElementById('recycleItems'),
                    emptyRecycleBtn: document.getElementById('emptyRecycleBtn'),
                    backFromRecycleBtn: document.getElementById('backFromRecycleBtn'),
                    toast: document.getElementById('toast'),
                    categoryModal: document.getElementById('categoryModal'),
                    categoryModalTitle: document.getElementById('categoryModalTitle'),
                    categoryNameInput: document.getElementById('categoryName'),
                    parentCategorySelect: document.getElementById('parentCategory'),
                    closeCategoryModal: document.getElementById('closeCategoryModal'),
                    cancelCategoryBtn: document.getElementById('cancelCategoryBtn'),
                    saveCategoryBtn: document.getElementById('saveCategoryBtn'),
                    notesPanel: document.getElementById('notesPanel'),
                    notesGrid: document.getElementById('notesGrid'),
                    notesList: document.getElementById('notesList'),
                    notesEmptyState: document.getElementById('notesEmptyState'),
                    newNoteBtn: document.getElementById('newNoteBtn'),
                    gridViewBtn: document.getElementById('gridViewBtn'),
                    listViewBtn: document.getElementById('listViewBtn'),
                    iconUrlInput: document.getElementById('iconUrl'),
                    iconPreview: document.getElementById('iconPreview'),
                    bindPhoneCheckbox: document.getElementById('bindPhone'),
                    bindEmailCheckbox: document.getElementById('bindEmail'),
                    bindWechatCheckbox: document.getElementById('bindWechat'),
                    bindQQCheckbox: document.getElementById('bindQQ'),
                    bindRealnameCheckbox: document.getElementById('bindRealname'),
                    bindOtherCheckbox: document.getElementById('bindOther'),
                    phoneInputs: document.getElementById('phoneInputs'),
                    emailInputs: document.getElementById('emailInputs'),
                    wechatInputs: document.getElementById('wechatInputs'),
                    qqInputs: document.getElementById('qqInputs'),
                    realnameInputs: document.getElementById('realnameInputs'),
                    otherInputs: document.getElementById('otherInputs'),
                    logsModal: document.getElementById('logsModal'),
                    closeLogsModal: document.getElementById('closeLogsModal'),
                    clearLogsBtn: document.getElementById('clearLogsBtn'),
                    logsContainer: document.getElementById('logsContainer'),
                    // 新增元素
                    addSubUrlBtn: document.getElementById('addSubUrlBtn'),
                    subUrlsContainer: document.getElementById('subUrlsContainer'),
                    subUrlsList: document.getElementById('subUrlsList'),
                    addAnotherSubUrlBtn: document.getElementById('addAnotherSubUrlBtn')
                };
            },
            
            // 加载设置
            loadSettings: function() {
                try {
                    const savedData = localStorage.getItem('spanData');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        this.userData = { ...this.userData, ...parsedData };
                        
                        // 恢复上次选择的分类
                        if (this.userData.settings.lastSelectedCategory) {
                            this.currentState.selectedCategory = this.userData.settings.lastSelectedCategory;
                        }
                        
                        addLog('加载数据', '从本地存储加载数据成功');
                    }
                    
                    // 应用设置
                    if (this.userData.settings.darkMode) {
                        document.body.classList.add('dark-mode');
                        this.elements.themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                        this.elements.themeBtn.title = '切换到亮色模式';
                    } else {
                        document.body.classList.remove('dark-mode');
                        this.elements.themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                        this.elements.themeBtn.title = '切换到暗色模式';
                    }
                    
                    if (this.userData.settings.sortingEnabled) {
                        this.elements.sortBtn.innerHTML = '<i class="fas fa-unlock"></i>';
                        this.elements.sortBtn.title = '锁定排序';
                        this.currentState.sortingEnabled = true;
                    } else {
                        this.elements.sortBtn.innerHTML = '<i class="fas fa-lock"></i>';
                        this.elements.sortBtn.title = '开启排序';
                        this.currentState.sortingEnabled = false;
                    }
                    
                    // 更新同步设置显示
                    this.updateSyncSettingsDisplay();
                } catch (e) {
                    console.error('加载设置失败:', e);
                    this.showToast('加载设置失败，使用默认设置', 'error');
                    addLog('加载设置', '加载设置失败: ' + e.message, 'error');
                }
            },
            
            // 保存数据
            saveData: function() {
                // 保存当前选择的分类到设置中
                this.userData.settings.lastSelectedCategory = this.currentState.selectedCategory;
                
                try {
                    localStorage.setItem('spanData', JSON.stringify(this.userData));
                } catch (e) {
                    console.error('保存数据失败:', e);
                    this.showToast('保存数据失败', 'error');
                    addLog('保存数据', '保存到本地存储失败: ' + e.message, 'error');
                }
            },
            
            // 设置事件监听器
            setupEventListeners: function() {
                const el = this.elements;
                const app = this;
                
                // 搜索功能
                if (el.searchBox) {
                    el.searchBox.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            if (el.localSearchBtn.classList.contains('active')) {
                                app.performLocalSearch();
                            } else {
                                app.performWebSearch();
                            }
                        }
                    });
                }
                
                // 本地搜索切换
                if (el.localSearchBtn) {
                    el.localSearchBtn.addEventListener('click', () => this.toggleLocalSearch());
                }
                
                // 页头按钮
                if (el.addUrlBtn) el.addUrlBtn.addEventListener('click', () => this.showAddUrlForm());
                if (el.notesBtn) el.notesBtn.addEventListener('click', () => this.showNotesPanel());
                if (el.functionsBtn) el.functionsBtn.addEventListener('click', () => this.showFunctionsPanel());
                if (el.themeBtn) el.themeBtn.addEventListener('click', () => this.toggleTheme());
                if (el.sortBtn) el.sortBtn.addEventListener('click', () => this.toggleSorting());
                
                // 批量操作按钮
                if (el.batchOperationsBtn) el.batchOperationsBtn.addEventListener('click', () => this.toggleBatchMode());
                
                // 批量操作栏按钮
                if (el.batchSelectAllBtn) el.batchSelectAllBtn.addEventListener('click', () => this.batchSelectAll());
                if (el.batchDeleteBtn) el.batchDeleteBtn.addEventListener('click', () => this.batchDeleteUrls());
                if (el.batchMoveBtn) el.batchMoveBtn.addEventListener('click', () => this.batchMoveUrls());
                if (el.cancelBatchBtn) el.cancelBatchBtn.addEventListener('click', () => this.cancelBatchMode());
                
                // 分类管理
                if (el.addCategoryBtn) el.addCategoryBtn.addEventListener('click', () => this.showAddCategoryModal());
                if (el.categorySettingsBtn) el.categorySettingsBtn.addEventListener('click', () => this.toggleCategorySettings());
                
                // 表单操作
                if (el.cancelAddBtn) el.cancelAddBtn.addEventListener('click', () => this.hideAddUrlForm());
                if (el.saveUrlBtn) el.saveUrlBtn.addEventListener('click', () => this.saveOrUpdateUrl());
                if (el.starToggle) el.starToggle.addEventListener('click', () => this.toggleStar());
                
                // 新增：子网址按钮事件
                if (el.addSubUrlBtn) el.addSubUrlBtn.addEventListener('click', () => this.addSubUrlRow());
                if (el.addAnotherSubUrlBtn) el.addAnotherSubUrlBtn.addEventListener('click', () => this.addSubUrlRow());
                
                // 功能按钮 - 注意：这里需要按照新的顺序绑定事件
                document.querySelectorAll('.function-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const functionName = this.dataset.function;
                        app.handleFunctionClick(functionName);
                    });
                });
                
                // 数据中心功能
                if (el.syncNowBtn) el.syncNowBtn.addEventListener('click', () => this.syncToGist());
                if (el.pullFromGistBtn) el.pullFromGistBtn.addEventListener('click', () => this.loadDataFromGist());
                if (el.syncInterval) el.syncInterval.addEventListener('change', () => this.saveSyncSettings());
                if (el.testTokenBtn) el.testTokenBtn.addEventListener('click', () => this.testToken());
                if (el.updateTokenBtn) el.updateTokenBtn.addEventListener('click', () => this.updateToken());
                if (el.clearTokenBtn) el.clearTokenBtn.addEventListener('click', () => this.clearToken());
                if (el.importBtn) el.importBtn.addEventListener('click', () => this.importData());
                if (el.exportBtn) el.exportBtn.addEventListener('click', () => this.exportData());
                if (el.backFromDataCenterBtn) el.backFromDataCenterBtn.addEventListener('click', () => this.showFunctionsPanel());
                
                // 回收站
                if (el.emptyRecycleBtn) el.emptyRecycleBtn.addEventListener('click', () => this.emptyRecycleBin());
                if (el.backFromRecycleBtn) el.backFromRecycleBtn.addEventListener('click', () => this.showFunctionsPanel());
                
                // 分类管理模态框
                if (el.closeCategoryModal) el.closeCategoryModal.addEventListener('click', () => this.hideCategoryModal());
                if (el.cancelCategoryBtn) el.cancelCategoryBtn.addEventListener('click', () => this.hideCategoryModal());
                if (el.saveCategoryBtn) el.saveCategoryBtn.addEventListener('click', () => this.saveCategory());
                
                // 绑定信息复选框事件
                if (el.bindPhoneCheckbox) el.bindPhoneCheckbox.addEventListener('change', () => this.toggleBindingInputs());
                if (el.bindEmailCheckbox) el.bindEmailCheckbox.addEventListener('change', () => this.toggleBindingInputs());
                if (el.bindWechatCheckbox) el.bindWechatCheckbox.addEventListener('change', () => this.toggleBindingInputs());
                if (el.bindQQCheckbox) el.bindQQCheckbox.addEventListener('change', () => this.toggleBindingInputs());
                if (el.bindRealnameCheckbox) el.bindRealnameCheckbox.addEventListener('change', () => this.toggleBindingInputs());
                if (el.bindOtherCheckbox) el.bindOtherCheckbox.addEventListener('change', () => this.toggleBindingInputs());
                
                // 图标URL输入事件
                if (el.iconUrlInput) {
                    el.iconUrlInput.addEventListener('input', () => {
                        if (this.iconTestTimer) {
                            clearTimeout(this.iconTestTimer);
                        }
                        
                        this.iconTestTimer = setTimeout(() => this.testIconUrl(), 500);
                        
                        const iconUrl = el.iconUrlInput.value.trim();
                        if (iconUrl) {
                            if (this.isValidUrl(iconUrl)) {
                                el.iconUrlInput.classList.remove('error');
                            } else {
                                el.iconUrlInput.classList.add('error');
                            }
                        } else {
                            el.iconUrlInput.classList.remove('error');
                        }
                    });
                }
                
                // 窗口大小调整时更新布局
                window.addEventListener('resize', () => this.updateLayout());
                
                // 操作日志相关事件
                if (el.closeLogsModal) el.closeLogsModal.addEventListener('click', () => this.hideLogsModal());
                if (el.clearLogsBtn) el.clearLogsBtn.addEventListener('click', () => this.clearLogs());
            },
            
            // 验证URL格式
            isValidUrl: function(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            },
            
            // 测试图标URL
            testIconUrl: function() {
                const el = this.elements;
                const iconUrl = el.iconUrlInput.value.trim();
                if (!el.iconPreview) return;
                
                el.iconPreview.innerHTML = '';
                
                if (!iconUrl) {
                    el.iconUrlInput.classList.remove('error');
                    el.iconPreview.innerHTML = '<span style="color: var(--text-light); font-size: 12px;">图标预览</span>';
                    return;
                }
                
                if (!this.isValidUrl(iconUrl)) {
                    el.iconUrlInput.classList.add('error');
                    el.iconPreview.innerHTML = '<span style="color: #e74c3c; font-size: 12px;">URL格式错误</span>';
                    return;
                }
                
                const img = new Image();
                img.onload = function() {
                    el.iconUrlInput.classList.remove('error');
                    el.iconPreview.innerHTML = '';
                    const previewImg = document.createElement('img');
                    previewImg.src = iconUrl;
                    previewImg.alt = '图标预览';
                    previewImg.style.maxWidth = '100%';
                    previewImg.style.maxHeight = '100%';
                    previewImg.style.objectFit = 'contain';
                    previewImg.style.backgroundColor = 'transparent';
                    el.iconPreview.appendChild(previewImg);
                };
                img.onerror = function() {
                    el.iconUrlInput.classList.add('error');
                    el.iconPreview.innerHTML = '<span style="color: #e74c3c; font-size: 12px;">图标加载失败</span>';
                };
                img.src = iconUrl;
            },
            
            // 切换本地搜索
            toggleLocalSearch: function() {
                const el = this.elements;
                if (!el.localSearchBtn) return;
                
                const wasActive = el.localSearchBtn.classList.contains('active');
                el.localSearchBtn.classList.toggle('active');
                
                if (!wasActive && el.localSearchBtn.classList.contains('active')) {
                    el.localSearchBtn.style.color = '#f1c40f';
                    this.showToast('已开启本地搜索模式', 'info');
                } else if (wasActive && !el.localSearchBtn.classList.contains('active')) {
                    el.localSearchBtn.style.color = 'var(--primary-color)';
                    this.showToast('已关闭本地搜索模式', 'info');
                }
            },
            
            // 执行网络搜索
            performWebSearch: function() {
                const el = this.elements;
                const query = el.searchBox.value.trim();
                if (query) {
                    window.open(`https://www.bing.com/search?q=${encodeURIComponent(query)}`, '_blank');
                } else {
                    this.showToast('请输入搜索关键词', 'warning');
                }
            },
            
            // 执行本地搜索
            performLocalSearch: function() {
                const el = this.elements;
                const query = el.searchBox.value.trim().toLowerCase();
                if (!query) {
                    this.renderUrls();
                    return;
                }
                
                const filteredUrls = this.userData.urls.filter(url => 
                    !url.deleted && (url.name.toLowerCase().includes(query) || 
                    url.url.toLowerCase().includes(query) ||
                    (url.description && url.description.toLowerCase().includes(query)))
                );
                
                this.renderUrlGrid(filteredUrls);
                this.showToast(`找到 ${filteredUrls.length} 个结果`, 'success');
            },
            
            // 渲染分类
            renderCategories: function() {
                const el = this.elements;
                if (!el.categoryList) return;
                
                el.categoryList.innerHTML = '';
                if (el.categoryListOptions) el.categoryListOptions.innerHTML = '';
                
                const allCategory = this.userData.categories.find(c => c.id === 'all');
                if (allCategory) {
                    const count = this.userData.urls.filter(url => !url.deleted).length;
                    const categoryItem = this.createCategoryElement(allCategory, count);
                    el.categoryList.appendChild(categoryItem);
                }
                
                const topLevelCategories = this.userData.categories
                    .filter(category => category.parentId === null && category.id !== 'all')
                    .sort((a, b) => a.order - b.order);
                
                topLevelCategories.forEach(category => {
                    const categoryIds = [category.id];
                    const subCategories = this.userData.categories
                        .filter(c => c.parentId === category.id)
                        .sort((a, b) => a.order - b.order);
                    
                    subCategories.forEach(sub => categoryIds.push(sub.id));
                    
                    const count = this.userData.urls.filter(url => 
                        !url.deleted && categoryIds.includes(url.category)
                    ).length;
                    
                    const categoryItem = this.createCategoryElement(category, count, 1);
                    el.categoryList.appendChild(categoryItem);
                    
                    // 添加到datalist选项
                    if (el.categoryListOptions) {
                        const option = document.createElement('option');
                        option.value = category.name;
                        el.categoryListOptions.appendChild(option);
                    }
                    
                    if (subCategories.length > 0) {
                        const subcategoryList = document.createElement('ul');
                        subcategoryList.className = `subcategory-list ${category.expanded === false ? 'collapsed' : ''}`;
                        subcategoryList.dataset.parent = category.id;
                        
                        subCategories.forEach(subCategory => {
                            const subCount = this.userData.urls.filter(url => !url.deleted && url.category === subCategory.id).length;
                            const subCategoryItem = this.createCategoryElement(subCategory, subCount, 2);
                            subcategoryList.appendChild(subCategoryItem);
                            
                            // 添加到datalist选项
                            if (el.categoryListOptions) {
                                const subOption = document.createElement('option');
                                subOption.value = subCategory.name;
                                el.categoryListOptions.appendChild(subOption);
                            }
                        });
                        
                        categoryItem.after(subcategoryList);
                    }
                });
                
                this.updateParentCategorySelect();
                
                if (this.currentState.categorySettingsMode) {
                    this.initCategorySortable();
                }
                
                setTimeout(() => {
                    this.setSubcategoryListHeights();
                }, 100);
            },
            
            // 创建分类元素
            createCategoryElement: function(category, count, level = 0) {
                const app = this;
                const categoryItem = document.createElement('li');
                
                let levelClass = '';
                if (level === 1) levelClass = 'level-1';
                if (level === 2) levelClass = 'level-2';
                
                const isCollapsed = category.expanded === false;
                if (isCollapsed) {
                    categoryItem.classList.add('collapsed');
                }
                
                categoryItem.className = `category-item ${levelClass} ${this.currentState.selectedCategory === category.id ? 'active' : ''}`;
                categoryItem.dataset.id = category.id;
                categoryItem.dataset.level = level;
                if (category.parentId) {
                    categoryItem.dataset.parent = category.parentId;
                }
                
                const folderIcon = level === 2 ? 'fa-folder' : 'fa-folder-open';
                
                if (this.currentState.categorySettingsMode && category.id !== 'all') {
                    categoryItem.classList.add('setting-mode');
                    categoryItem.innerHTML = `
                        <div class="category-name">
                            <i class="fas ${folderIcon}"></i>
                            <span>${category.name}</span>
                        </div>
                        <span class="category-count">${count || 0}</span>
                        <div class="category-edit-btns">
                            <button class="category-edit-btn edit-category-btn" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="category-edit-btn delete-category-btn" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                            <i class="fas fa-grip-vertical category-drag" title="拖拽排序"></i>
                        </div>
                    `;
                } else {
                    const hasSubcategories = level === 1 && this.userData.categories.filter(c => c.parentId === category.id).length > 0;
                    const isAllCategory = category.id === 'all';
                    
                    let collapseIconHTML = '';
                    if (hasSubcategories || isAllCategory) {
                        const iconClass = (isAllCategory ? this.userData.settings.allCategoriesExpanded : category.expanded) !== false ? 'fa-chevron-down' : 'fa-chevron-right';
                        collapseIconHTML = `<div class="collapse-icon" title="${isAllCategory ? '展开/折叠所有分类' : '展开/折叠子分类'}"><i class="fas ${iconClass}"></i></div>`;
                    }
                    
                    categoryItem.innerHTML = `
                        <div class="category-name">
                            <i class="fas ${folderIcon}"></i>
                            <span>${category.name}</span>
                            ${count !== null && count !== undefined ? `<span class="category-count">${count}</span>` : ''}
                            ${collapseIconHTML}
                        </div>
                    `;
                }
                
                categoryItem.addEventListener('click', function(e) {
                    if (e.target.closest('.collapse-icon')) {
                        return;
                    }
                    
                    if (e.target.closest('.category-edit-btn')) {
                        return;
                    }
                    
                    if (app.currentState.view !== 'urls') {
                        app.showUrlsView();
                    }
                    
                    document.querySelectorAll('.category-item').forEach(item => item.classList.remove('active'));
                    this.classList.add('active');
                    app.currentState.selectedCategory = category.id;
                    app.renderUrls();
                });
                
                const collapseIcon = categoryItem.querySelector('.collapse-icon');
                if (collapseIcon) {
                    collapseIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        if (category.id === 'all') {
                            app.toggleAllCategories();
                        } else if (level === 1) {
                            app.toggleCategoryCollapse(category);
                        }
                    });
                }
                
                if (this.currentState.categorySettingsMode && category.id !== 'all') {
                    const editBtn = categoryItem.querySelector('.edit-category-btn');
                    const deleteBtn = categoryItem.querySelector('.delete-category-btn');
                    
                    if (editBtn) {
                        editBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            app.editCategory(category);
                        });
                    }
                    
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            app.deleteCategory(category);
                        });
                    }
                }
                
                return categoryItem;
            },
            
            // 切换所有分类的展开/折叠状态
            toggleAllCategories: function() {
                this.userData.settings.allCategoriesExpanded = !this.userData.settings.allCategoriesExpanded;
                
                this.userData.categories.forEach(category => {
                    if (category.parentId === null && category.id !== 'all') {
                        category.expanded = this.userData.settings.allCategoriesExpanded;
                    }
                });
                
                this.saveData();
                this.renderCategories();
                this.showToast(this.userData.settings.allCategoriesExpanded ? '已展开所有分类' : '已折叠所有分类', 'info');
            },
            
            // 切换单个分类的展开/折叠状态
            toggleCategoryCollapse: function(category) {
                category.expanded = !category.expanded;
                
                this.saveData();
                
                const categoryItem = document.querySelector(`.category-item[data-id="${category.id}"]`);
                const subcategoryList = document.querySelector(`.subcategory-list[data-parent="${category.id}"]`);
                const collapseIcon = categoryItem?.querySelector('.collapse-icon i');
                
                if (category.expanded === false) {
                    if (categoryItem) categoryItem.classList.add('collapsed');
                    if (subcategoryList) {
                        subcategoryList.classList.add('collapsed');
                        subcategoryList.style.maxHeight = '0';
                    }
                    if (collapseIcon) collapseIcon.className = 'fas fa-chevron-right';
                } else {
                    if (categoryItem) categoryItem.classList.remove('collapsed');
                    if (subcategoryList) {
                        subcategoryList.classList.remove('collapsed');
                        subcategoryList.style.maxHeight = subcategoryList.scrollHeight + 'px';
                    }
                    if (collapseIcon) collapseIcon.className = 'fas fa-chevron-down';
                }
                
                this.showToast(category.expanded === false ? `已折叠"${category.name}"分类` : `已展开"${category.name}"分类`, 'info');
            },
            
            // 更新父级分类选择下拉框
            updateParentCategorySelect: function() {
                const el = this.elements;
                if (!el.parentCategorySelect) return;
                
                el.parentCategorySelect.innerHTML = '<option value="">无 (一级分类)</option>';
                
                const topLevelCategories = this.userData.categories
                    .filter(category => category.parentId === null && category.id !== 'all')
                    .sort((a, b) => a.order - b.order);
                
                topLevelCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    el.parentCategorySelect.appendChild(option);
                });
            },
            
            // 渲染网址列表 - 按创建时间倒序排列
            renderUrls: function() {
                const el = this.elements;
                if (!el.sectionTitle || !el.urlsGrid) return;
                
                const category = this.userData.categories.find(c => c.id === this.currentState.selectedCategory);
                el.sectionTitle.textContent = category ? category.name : '全部';
                
                let filteredUrls = this.userData.urls.filter(url => !url.deleted);
                if (this.currentState.selectedCategory !== 'all') {
                    const categoryIds = [this.currentState.selectedCategory];
                    const subCategories = this.userData.categories.filter(c => c.parentId === this.currentState.selectedCategory);
                    subCategories.forEach(sub => categoryIds.push(sub.id));
                    
                    filteredUrls = filteredUrls.filter(url => categoryIds.includes(url.category));
                }
                
                // 按创建时间倒序排列
                filteredUrls.sort((a, b) => {
                    const dateA = new Date(a.createdAt || '2000-01-01');
                    const dateB = new Date(b.createdAt || '2000-01-01');
                    return dateB - dateA;
                });
                
                this.renderUrlGrid(filteredUrls);
            },
            
            // 渲染网址网格
            renderUrlGrid: function(urls) {
                const el = this.elements;
                if (!el.urlsGrid) return;
                
                el.urlsGrid.innerHTML = '';
                
                if (urls.length === 0) {
                    el.urlsGrid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="far fa-folder-open"></i>
                            <h3>暂无网址</h3>
                            <p>点击左上角的"+"按钮添加第一个网址</p>
                        </div>
                    `;
                    return;
                }
                
                const app = this;
                urls.forEach(url => {
                    const urlCard = document.createElement('div');
                    urlCard.className = `url-card fade-in sortable-item ${this.currentState.batchMode ? 'select-mode' : ''}`;
                    urlCard.dataset.id = url.id;
                    
                    const isSelected = this.currentState.selectedUrls.includes(url.id);
                    
                    if (this.currentState.batchMode) {
                        urlCard.innerHTML = `
                            <div class="url-checkbox-container">
                                <input type="checkbox" class="url-checkbox" id="url-checkbox-${url.id}" ${isSelected ? 'checked' : ''}>
                            </div>
                            <div class="url-icon">
                                ${url.icon && url.icon.startsWith('http') ? `<img src="${url.icon}" alt="${url.name}" onerror="app.handleIconError(this, '${url.name.charAt(0).toUpperCase()}')">` : (url.icon || url.name.charAt(0).toUpperCase())}
                            </div>
                            <div class="url-name">${url.name}</div>
                        `;
                        
                        const checkbox = urlCard.querySelector('.url-checkbox');
                        checkbox.addEventListener('change', function() {
                            app.toggleUrlSelection(url.id, this.checked);
                        });
                        
                        urlCard.addEventListener('click', function(e) {
                            if (!e.target.closest('.url-checkbox-container')) {
                                const checkbox = this.querySelector('.url-checkbox');
                                checkbox.checked = !checkbox.checked;
                                app.toggleUrlSelection(url.id, checkbox.checked);
                            }
                        });
                    } else {
                        urlCard.innerHTML = `
                            <div class="url-icon">
                                ${url.icon && url.icon.startsWith('http') ? `<img src="${url.icon}" alt="${url.name}" onerror="app.handleIconError(this, '${url.name.charAt(0).toUpperCase()}')">` : (url.icon || url.name.charAt(0).toUpperCase())}
                            </div>
                            <div class="url-name">${url.name}</div>
                            <div class="url-expand">
                                <i class="fas fa-ellipsis-h"></i>
                            </div>
                        `;
                        
                        urlCard.addEventListener('click', function(e) {
                            if (!e.target.closest('.url-expand')) {
                                window.open(url.url, '_blank');
                            }
                        });
                        
                        const expandBtn = urlCard.querySelector('.url-expand');
                        expandBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            app.showUrlDetail(url, 'normal');
                        });
                    }
                    
                    el.urlsGrid.appendChild(urlCard);
                });
                
                if (this.currentState.sortingEnabled && !this.currentState.batchMode) {
                    this.initSortable();
                }
                
                this.updateSelectedCount();
            },
            
            // 处理图标加载错误
            handleIconError: function(imgElement, fallbackText) {
                const parent = imgElement.parentElement;
                imgElement.style.display = 'none';
                parent.innerHTML = fallbackText;
                parent.style.display = 'flex';
                parent.style.alignItems = 'center';
                parent.style.justifyContent = 'center';
                parent.style.fontSize = '16px';
                parent.style.fontWeight = 'bold';
                parent.style.color = 'var(--primary-color)';
            },
            
            // 处理回收站图标加载错误
            handleRecycleIconError: function(imgElement, fallbackText) {
                const parent = imgElement.parentElement;
                imgElement.style.display = 'none';
                parent.innerHTML = fallbackText;
                parent.style.display = 'flex';
                parent.style.alignItems = 'center';
                parent.style.justifyContent = 'center';
                parent.style.fontSize = '16px';
                parent.style.fontWeight = 'bold';
                parent.style.color = 'var(--primary-color)';
            },
            
            // 更新星标网址区域
            updateStarredSection: function() {
                const el = this.elements;
                if (!el.starredSection || !el.starredItems) return;
                
                const starredUrls = this.userData.urls.filter(url => !url.deleted && url.starred);
                
                if (starredUrls.length > 0) {
                    el.starredSection.classList.add('has-items');
                    
                    if (this.currentState.batchMode) {
                        el.starredSection.classList.add('batch-mode');
                    } else {
                        el.starredSection.classList.remove('batch-mode');
                    }
                    
                    el.starredItems.innerHTML = '';
                    
                    const app = this;
                    starredUrls.forEach(url => {
                        const item = document.createElement('div');
                        item.className = 'starred-item';
                        item.dataset.id = url.id;
                        
                        if (this.currentState.batchMode) {
                            const isSelected = this.currentState.selectedUrls.includes(url.id);
                            item.innerHTML = `
                                <input type="checkbox" class="starred-checkbox" id="starred-checkbox-${url.id}" ${isSelected ? 'checked' : ''}>
                                <div class="starred-icon">
                                    ${url.icon && url.icon.startsWith('http') ? `<img src="${url.icon}" alt="${url.name}" onerror="app.handleIconError(this, '${url.name.charAt(0).toUpperCase()}')">` : (url.icon || url.name.charAt(0).toUpperCase())}
                                </div>
                                <div class="starred-name">${url.name}</div>
                            `;
                            
                            const checkbox = item.querySelector('.starred-checkbox');
                            checkbox.addEventListener('change', function() {
                                app.toggleUrlSelection(url.id, this.checked);
                            });
                            
                            item.addEventListener('click', function(e) {
                                if (!e.target.classList.contains('starred-checkbox')) {
                                    const checkbox = this.querySelector('.starred-checkbox');
                                    checkbox.checked = !checkbox.checked;
                                    app.toggleUrlSelection(url.id, checkbox.checked);
                                }
                            });
                        } else {
                            item.innerHTML = `
                                <div class="starred-icon">
                                    ${url.icon && url.icon.startsWith('http') ? `<img src="${url.icon}" alt="${url.name}" onerror="app.handleIconError(this, '${url.name.charAt(0).toUpperCase()}')">` : (url.icon || url.name.charAt(0).toUpperCase())}
                                </div>
                                <div class="starred-name">${url.name}</div>
                            `;
                        }
                        
                        if (!this.currentState.batchMode) {
                            item.addEventListener('click', function(e) {
                                window.open(url.url, '_blank');
                            });
                        }
                        
                        el.starredItems.appendChild(item);
                    });
                } else {
                    el.starredSection.classList.remove('has-items');
                    el.starredSection.classList.remove('batch-mode');
                }
            },
            
            // 切换批量模式
            toggleBatchMode: function() {
                this.currentState.batchMode = !this.currentState.batchMode;
                const el = this.elements;
                if (!el.batchOperationsBtn || !el.batchOperationsBar) return;
                
                if (this.currentState.batchMode) {
                    el.batchOperationsBtn.classList.add('active');
                    el.batchOperationsBtn.title = '退出批量操作';
                    el.batchOperationsBar.classList.add('active');
                    this.showToast('已进入批量操作模式', 'info');
                    addLog('批量操作', '进入批量操作模式');
                } else {
                    el.batchOperationsBtn.classList.remove('active');
                    el.batchOperationsBtn.title = '批量操作';
                    el.batchOperationsBar.classList.remove('active');
                    this.currentState.selectedUrls = [];
                    this.showToast('已退出批量操作模式', 'info');
                    addLog('批量操作', '退出批量操作模式');
                }
                
                this.renderUrls();
                this.updateStarredSection();
                this.updateBatchButtons();
            },
            
            // 取消批量模式
            cancelBatchMode: function() {
                this.currentState.batchMode = false;
                const el = this.elements;
                if (!el.batchOperationsBtn || !el.batchOperationsBar) return;
                
                el.batchOperationsBtn.classList.remove('active');
                el.batchOperationsBtn.title = '批量操作';
                el.batchOperationsBar.classList.remove('active');
                
                this.currentState.selectedUrls = [];
                
                this.renderUrls();
                this.updateStarredSection();
                this.updateBatchButtons();
            },
            
            // 批量全选
            batchSelectAll: function() {
                const filteredUrls = this.getCurrentUrls();
                
                if (this.currentState.selectedUrls.length === filteredUrls.length) {
                    this.currentState.selectedUrls = [];
                } else {
                    this.currentState.selectedUrls = filteredUrls.map(url => url.id);
                }
                
                this.renderUrls();
                this.updateStarredSection();
                this.updateBatchButtons();
            },
            
            // 切换网址选择状态
            toggleUrlSelection: function(urlId, selected) {
                if (selected && !this.currentState.selectedUrls.includes(urlId)) {
                    this.currentState.selectedUrls.push(urlId);
                } else if (!selected && this.currentState.selectedUrls.includes(urlId)) {
                    const index = this.currentState.selectedUrls.indexOf(urlId);
                    if (index !== -1) {
                        this.currentState.selectedUrls.splice(index, 1);
                    }
                }
                
                this.updateSelectedCount();
                this.updateBatchButtons();
            },
            
            // 更新选中计数
            updateSelectedCount: function() {
                const el = this.elements;
                if (!el.selectedCount) return;
                
                el.selectedCount.textContent = `已选择 ${this.currentState.selectedUrls.length} 个网址`;
            },
            
            // 更新批量操作按钮状态
            updateBatchButtons: function() {
                const el = this.elements;
                if (!el.batchDeleteBtn || !el.batchMoveBtn || !el.batchSelectAllBtn) return;
                
                const hasSelected = this.currentState.selectedUrls.length > 0;
                
                el.batchDeleteBtn.disabled = !hasSelected;
                el.batchMoveBtn.disabled = !hasSelected;
                
                if (!hasSelected) {
                    el.batchDeleteBtn.style.opacity = '0.5';
                    el.batchMoveBtn.style.opacity = '0.5';
                } else {
                    el.batchDeleteBtn.style.opacity = '1';
                    el.batchMoveBtn.style.opacity = '1';
                }
                
                const filteredUrls = this.getCurrentUrls();
                if (this.currentState.selectedUrls.length === filteredUrls.length && filteredUrls.length > 0) {
                    el.batchSelectAllBtn.innerHTML = '<i class="fas fa-times"></i> 取消全选';
                } else {
                    el.batchSelectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> 全选';
                }
            },
            
            // 显示新增网址表单 - 默认选中当前分类
            showAddUrlForm: function() {
                const el = this.elements;
                if (!el.addUrlForm || !el.formActionTitle || !el.saveUrlBtn) return;
                
                el.addUrlForm.classList.remove('hidden');
                el.functionsPanel.classList.add('hidden');
                el.recycleBinPanel.classList.remove('active');
                el.recycleBinPanel.classList.add('hidden');
                el.urlsSection.classList.add('hidden');
                el.starredSection.classList.add('hidden');
                el.notesPanel.classList.add('hidden');
                el.dataCenterPanel.classList.add('hidden');
                this.currentState.view = 'addForm';
                this.currentState.editingUrl = null;
                
                this.resetAddUrlForm();
                el.formActionTitle.textContent = '新增网址';
                el.saveUrlBtn.textContent = '保存网址';
                
                // 默认选中当前分类
                if (this.currentState.selectedCategory !== 'all') {
                    const category = this.userData.categories.find(c => c.id === this.currentState.selectedCategory);
                    if (category && el.categoryInput) {
                        el.categoryInput.value = category.name;
                    }
                }
            },
            
            // 显示网址视图
            showUrlsView: function() {
                const el = this.elements;
                if (!el.addUrlForm || !el.urlsSection) return;
                
                el.addUrlForm.classList.add('hidden');
                el.functionsPanel.classList.add('hidden');
                el.recycleBinPanel.classList.remove('active');
                el.recycleBinPanel.classList.add('hidden');
                el.notesPanel.classList.add('hidden');
                el.dataCenterPanel.classList.add('hidden');
                el.urlsSection.classList.remove('hidden');
                el.starredSection.classList.remove('hidden');
                this.currentState.view = 'urls';
            },
            
            // 显示功能面板
            showFunctionsPanel: function() {
                const el = this.elements;
                if (!el.functionsPanel) return;
                
                el.functionsPanel.classList.remove('hidden');
                el.recycleBinPanel.classList.remove('active');
                el.recycleBinPanel.classList.add('hidden');
                el.addUrlForm.classList.add('hidden');
                el.urlsSection.classList.add('hidden');
                el.starredSection.classList.add('hidden');
                el.notesPanel.classList.add('hidden');
                el.dataCenterPanel.classList.add('hidden');
                this.currentState.view = 'functions';
            },
            
            // 显示数据中心面板
            showDataCenter: function() {
                const el = this.elements;
                if (!el.dataCenterPanel) return;
                
                el.functionsPanel.classList.add('hidden');
                el.recycleBinPanel.classList.remove('active');
                el.recycleBinPanel.classList.add('hidden');
                el.addUrlForm.classList.add('hidden');
                el.urlsSection.classList.add('hidden');
                el.starredSection.classList.add('hidden');
                el.notesPanel.classList.add('hidden');
                el.dataCenterPanel.classList.remove('hidden');
                this.currentState.view = 'datacenter';
                
                // 更新数据中心显示
                this.updateSyncSettingsDisplay();
                this.updateLastSyncTime();
            },
            
            // 显示便签面板
            showNotesPanel: function() {
                const el = this.elements;
                if (!el.notesPanel) return;
                
                el.functionsPanel.classList.add('hidden');
                el.recycleBinPanel.classList.remove('active');
                el.recycleBinPanel.classList.add('hidden');
                el.addUrlForm.classList.add('hidden');
                el.urlsSection.classList.add('hidden');
                el.starredSection.classList.add('hidden');
                el.notesPanel.classList.remove('hidden');
                el.dataCenterPanel.classList.add('hidden');
                this.currentState.view = 'notes';
                
                // 初始化便签视图
                if (this.notesManager) {
                    this.notesManager.switchView(this.userData.settings.noteView || 'grid');
                    this.notesManager.renderNotes();
                }
            },
            
            // 隐藏新增网址表单
            hideAddUrlForm: function() {
                const el = this.elements;
                if (!el.addUrlForm || !el.urlsSection) return;
                
                el.addUrlForm.classList.add('hidden');
                el.urlsSection.classList.remove('hidden');
                el.starredSection.classList.remove('hidden');
                el.notesPanel.classList.add('hidden');
                el.dataCenterPanel.classList.add('hidden');
                this.currentState.view = 'urls';
                this.currentState.editingUrl = null;
            },
            
            // 重置新增网址表单
            resetAddUrlForm: function() {
                const el = this.elements;
                if (!el.categoryInput || !el.starToggle) return;
                
                const urlInput = document.getElementById('url');
                const nameInput = document.getElementById('name');
                const iconUrlInput = document.getElementById('iconUrl');
                const accountInput = document.getElementById('account');
                const passwordInput = document.getElementById('password');
                const descriptionInput = document.getElementById('description');
                
                if (urlInput) urlInput.value = '';
                if (nameInput) nameInput.value = '';
                if (el.categoryInput) el.categoryInput.value = '';
                if (iconUrlInput) iconUrlInput.value = '';
                if (accountInput) accountInput.value = '';
                if (passwordInput) passwordInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                
                if (el.starToggle) {
                    const starIcon = el.starToggle.querySelector('i');
                    if (starIcon) {
                        starIcon.classList.remove('fas');
                        starIcon.classList.add('far');
                        el.starToggle.classList.remove('active');
                    }
                }
                
                this.resetBindingInputs();
                
                if (el.iconPreview) {
                    el.iconPreview.innerHTML = '<span style="color: var(--text-light); font-size: 12px;">图标预览</span>';
                }
                if (el.iconUrlInput) {
                    el.iconUrlInput.classList.remove('error');
                }
                
                // 清空子网址
                if (el.subUrlsList) el.subUrlsList.innerHTML = '';
                if (el.subUrlsContainer) el.subUrlsContainer.classList.add('hidden');
                this.subUrlCounter = 0;
            },
            
            // 切换星标
            toggleStar: function() {
                const el = this.elements;
                if (!el.starToggle) return;
                
                const icon = el.starToggle.querySelector('i');
                if (!icon) return;
                
                if (icon.classList.contains('far')) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    el.starToggle.classList.add('active');
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    el.starToggle.classList.remove('active');
                }
            },
            
            // 切换绑定信息输入框显示
            toggleBindingInputs: function() {
                const el = this.elements;
                
                if (el.bindPhoneCheckbox && el.phoneInputs) {
                    if (el.bindPhoneCheckbox.checked) {
                        el.phoneInputs.classList.add('active');
                    } else {
                        el.phoneInputs.classList.remove('active');
                        const phoneValue = document.getElementById('phoneValue');
                        if (phoneValue) phoneValue.value = '';
                    }
                }
                
                if (el.bindEmailCheckbox && el.emailInputs) {
                    if (el.bindEmailCheckbox.checked) {
                        el.emailInputs.classList.add('active');
                    } else {
                        el.emailInputs.classList.remove('active');
                        const emailValue = document.getElementById('emailValue');
                        if (emailValue) emailValue.value = '';
                    }
                }
                
                if (el.bindWechatCheckbox && el.wechatInputs) {
                    if (el.bindWechatCheckbox.checked) {
                        el.wechatInputs.classList.add('active');
                    } else {
                        el.wechatInputs.classList.remove('active');
                        const wechatValue = document.getElementById('wechatValue');
                        if (wechatValue) wechatValue.value = '';
                    }
                }
                
                if (el.bindQQCheckbox && el.qqInputs) {
                    if (el.bindQQCheckbox.checked) {
                        el.qqInputs.classList.add('active');
                    } else {
                        el.qqInputs.classList.remove('active');
                        const qqValue = document.getElementById('qqValue');
                        if (qqValue) qqValue.value = '';
                    }
                }
                
                if (el.bindRealnameCheckbox && el.realnameInputs) {
                    if (el.bindRealnameCheckbox.checked) {
                        el.realnameInputs.classList.add('active');
                    } else {
                        el.realnameInputs.classList.remove('active');
                        const verifiedRadio = document.querySelector('input[name="realnameStatus"][value="verified"]');
                        if (verifiedRadio) verifiedRadio.checked = true;
                    }
                }
                
                if (el.bindOtherCheckbox && el.otherInputs) {
                    if (el.bindOtherCheckbox.checked) {
                        el.otherInputs.classList.add('active');
                    } else {
                        el.otherInputs.classList.remove('active');
                        const otherValue = document.getElementById('otherValue');
                        if (otherValue) otherValue.value = '';
                    }
                }
            },
            
            // 重置绑定信息输入框
            resetBindingInputs: function() {
                const el = this.elements;
                
                if (el.bindPhoneCheckbox) el.bindPhoneCheckbox.checked = false;
                if (el.bindEmailCheckbox) el.bindEmailCheckbox.checked = false;
                if (el.bindWechatCheckbox) el.bindWechatCheckbox.checked = false;
                if (el.bindQQCheckbox) el.bindQQCheckbox.checked = false;
                if (el.bindRealnameCheckbox) el.bindRealnameCheckbox.checked = false;
                if (el.bindOtherCheckbox) el.bindOtherCheckbox.checked = false;
                
                if (el.phoneInputs) el.phoneInputs.classList.remove('active');
                if (el.emailInputs) el.emailInputs.classList.remove('active');
                if (el.wechatInputs) el.wechatInputs.classList.remove('active');
                if (el.qqInputs) el.qqInputs.classList.remove('active');
                if (el.realnameInputs) el.realnameInputs.classList.remove('active');
                if (el.otherInputs) el.otherInputs.classList.remove('active');
                
                const phoneValue = document.getElementById('phoneValue');
                const emailValue = document.getElementById('emailValue');
                const wechatValue = document.getElementById('wechatValue');
                const qqValue = document.getElementById('qqValue');
                const otherValue = document.getElementById('otherValue');
                
                if (phoneValue) phoneValue.value = '';
                if (emailValue) emailValue.value = '';
                if (wechatValue) wechatValue.value = '';
                if (qqValue) qqValue.value = '';
                if (otherValue) otherValue.value = '';
                
                const verifiedRadio = document.querySelector('input[name="realnameStatus"][value="verified"]');
                if (verifiedRadio) verifiedRadio.checked = true;
            },
            
            // 根据分类名称获取分类ID
            getCategoryIdByName: function(categoryName) {
                const category = this.userData.categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                if (category) {
                    return category.id;
                }
                return null;
            },
            
            // 新增：添加子网址行
            addSubUrlRow: function() {
                const el = this.elements;
                if (!el.subUrlsList || !el.subUrlsContainer) return;
                
                // 显示子网址容器
                el.subUrlsContainer.classList.remove('hidden');
                
                const subUrlId = this.subUrlCounter++;
                const subUrlRow = document.createElement('div');
                subUrlRow.className = 'sub-url-row';
                subUrlRow.dataset.id = subUrlId;
                subUrlRow.innerHTML = `
                    <input type="text" class="sub-url-name-input" placeholder="子网址名称" data-id="${subUrlId}">
                    <input type="url" class="sub-url-input" placeholder="子网址网址" data-id="${subUrlId}">
                    <button class="sub-url-delete-btn" data-id="${subUrlId}" type="button">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                el.subUrlsList.appendChild(subUrlRow);
                
                // 绑定删除按钮事件
                const deleteBtn = subUrlRow.querySelector('.sub-url-delete-btn');
                deleteBtn.addEventListener('click', () => {
                    subUrlRow.remove();
                    
                    // 如果没有子网址了，隐藏容器
                    if (el.subUrlsList.children.length === 0) {
                        el.subUrlsContainer.classList.add('hidden');
                    }
                });
            },
            
            // 新增：获取子网址数据
            getSubUrlsData: function() {
                const el = this.elements;
                if (!el.subUrlsList || el.subUrlsContainer.classList.contains('hidden')) {
                    return [];
                }
                
                const subUrls = [];
                const subUrlRows = el.subUrlsList.querySelectorAll('.sub-url-row');
                
                subUrlRows.forEach(row => {
                    const nameInput = row.querySelector('.sub-url-name-input');
                    const urlInput = row.querySelector('.sub-url-input');
                    
                    if (nameInput.value.trim() && urlInput.value.trim()) {
                        subUrls.push({
                            name: nameInput.value.trim(),
                            url: urlInput.value.trim()
                        });
                    }
                });
                
                return subUrls;
            },
            
            // 保存或更新网址 - 支持自定义分类和子网址
            saveOrUpdateUrl: function() {
                const el = this.elements;
                if (!el.categoryInput || !el.starToggle) return;
                
                const urlInput = document.getElementById('url');
                const nameInput = document.getElementById('name');
                const categoryInputValue = el.categoryInput.value.trim();
                const iconUrlInputValue = el.iconUrlInput ? el.iconUrlInput.value : '';
                const accountInput = document.getElementById('account');
                const passwordInput = document.getElementById('password');
                const descriptionInput = document.getElementById('description');
                const isStarred = el.starToggle.classList.contains('active');
                
                // 获取子网址数据
                const subUrls = this.getSubUrlsData();
                
                const bindings = {};
                if (el.bindPhoneCheckbox?.checked) {
                    const phoneValue = document.getElementById('phoneValue');
                    if (phoneValue && phoneValue.value) {
                        bindings.phone = phoneValue.value;
                    }
                }
                if (el.bindEmailCheckbox?.checked) {
                    const emailValue = document.getElementById('emailValue');
                    if (emailValue && emailValue.value) {
                        bindings.email = emailValue.value;
                    }
                }
                if (el.bindWechatCheckbox?.checked) {
                    const wechatValue = document.getElementById('wechatValue');
                    if (wechatValue && wechatValue.value) {
                        bindings.wechat = wechatValue.value;
                    }
                }
                if (el.bindQQCheckbox?.checked) {
                    const qqValue = document.getElementById('qqValue');
                    if (qqValue && qqValue.value) {
                        bindings.qq = qqValue.value;
                    }
                }
                if (el.bindRealnameCheckbox?.checked) {
                    const realnameStatus = document.querySelector('input[name="realnameStatus"]:checked');
                    if (realnameStatus) {
                        bindings.realname = realnameStatus.value === 'verified' ? '已实名' : '未实名';
                    }
                }
                if (el.bindOtherCheckbox?.checked) {
                    const otherValue = document.getElementById('otherValue');
                    if (otherValue && otherValue.value) {
                        bindings.other = otherValue.value;
                    }
                }
                
                if (!urlInput?.value || !nameInput?.value) {
                    this.showToast('网址和名称不能为空', 'error');
                    return;
                }
                
                if (!categoryInputValue) {
                    this.showToast('请选择或输入分类', 'error');
                    return;
                }
                
                let icon = nameInput.value.charAt(0).toUpperCase();
                if (iconUrlInputValue && el.iconUrlInput && !el.iconUrlInput.classList.contains('error')) {
                    icon = iconUrlInputValue;
                }
                
                // 处理分类：检查是否存在，不存在则创建新分类
                let categoryId = this.getCategoryIdByName(categoryInputValue);
                let categoryName = categoryInputValue;
                
                if (!categoryId) {
                    // 创建新分类
                    const newCategory = {
                        id: 'category_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: categoryName,
                        parentId: null,
                        order: this.userData.categories.filter(c => c.parentId === null && c.id !== 'all').length,
                        level: 1,
                        expanded: true
                    };
                    
                    this.userData.categories.push(newCategory);
                    categoryId = newCategory.id;
                    
                    this.showToast(`已创建新分类"${categoryName}"`, 'success');
                } else {
                    categoryName = this.userData.categories.find(c => c.id === categoryId).name;
                }
                
                if (this.currentState.editingUrl) {
                    this.currentState.editingUrl.name = nameInput.value;
                    this.currentState.editingUrl.url = urlInput.value;
                    this.currentState.editingUrl.category = categoryId;
                    this.currentState.editingUrl.starred = isStarred;
                    this.currentState.editingUrl.icon = icon;
                    this.currentState.editingUrl.account = accountInput?.value || '';
                    this.currentState.editingUrl.password = passwordInput?.value || '';
                    this.currentState.editingUrl.description = descriptionInput?.value || '';
                    this.currentState.editingUrl.bindings = bindings;
                    this.currentState.editingUrl.subUrls = subUrls;
                    
                    this.showToast('网址已更新', 'success');
                    addLog('更新网址', `更新网址: ${nameInput.value}`, 'success');
                } else {
                    const newUrl = {
                        id: this.userData.urls.length > 0 ? Math.max(...this.userData.urls.map(u => u.id)) + 1 : 1,
                        name: nameInput.value,
                        url: urlInput.value,
                        category: categoryId,
                        starred: isStarred,
                        icon: icon,
                        account: accountInput?.value || '',
                        password: passwordInput?.value || '',
                        description: descriptionInput?.value || '',
                        bindings: bindings,
                        subUrls: subUrls,
                        deleted: false,
                        deletedAt: null,
                        createdAt: new Date().toISOString() // 添加创建时间
                    };
                    
                    this.userData.urls.push(newUrl);
                    this.showToast('网址已保存', 'success');
                    addLog('新增网址', `新增网址: ${nameInput.value}`, 'success');
                }
                
                this.saveData();
                this.hideAddUrlForm();
                this.renderCategories();
                this.renderUrls();
                this.updateStarredSection();
                
                // 自动同步到Gist
                setTimeout(() => this.syncToGist(), 1000);
            },
            
            // 显示网址详情 - 优化版
            showUrlDetail: function(url, context = 'normal') {
                const app = this;
                this.currentState.currentContext = context;
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                
                // 密码显示状态
                let passwordVisible = false;
                let passwordHideTimer = null;
                
                // 绑定信息和子网址展开状态
                const bindingsExpanded = this.currentState.detailExpanded.bindings;
                const subUrlsExpanded = this.currentState.detailExpanded.subUrls;
                
                // 创建绑定信息行
                let bindingsHTML = '';
                if (url.bindings && Object.keys(url.bindings).length > 0) {
                    const bindingEntries = Object.entries(url.bindings);
                    const bindingLabels = {
                        phone: '手机号',
                        email: '邮箱',
                        wechat: '微信',
                        qq: 'QQ号',
                        realname: '实名状态',
                        other: '其他'
                    };
                    
                    bindingsHTML = bindingEntries.map(([key, value]) => `
                        <div class="binding-info-row">
                            <div class="binding-info-label">${bindingLabels[key] || key}：</div>
                            <div class="binding-info-value">${value}</div>
                        </div>
                    `).join('');
                }
                
                // 创建子网址行
                let subUrlsHTML = '';
                if (url.subUrls && url.subUrls.length > 0) {
                    subUrlsHTML = url.subUrls.map(subUrl => `
                        <div class="sub-url-item">
                            <div class="sub-url-info">
                                <div class="sub-url-name">${subUrl.name}</div>
                                <div class="sub-url-url">${subUrl.url}</div>
                            </div>
                            <div class="sub-url-actions">
                                <button class="sub-url-action-btn copy-sub-url-btn" data-url="${subUrl.url}">复制</button>
                                <button class="sub-url-action-btn visit-sub-url-btn" data-url="${subUrl.url}">访问</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <!-- 标题栏 -->
                        <div class="detail-modal-header">
                            <h3 class="detail-title">网址详情</h3>
                            <div class="detail-header-buttons">
                                <button class="detail-header-btn" id="visitUrlBtn">访问</button>
                                <button class="detail-header-btn secondary" id="editUrlBtn">编辑</button>
                                <button class="detail-header-btn secondary" id="toggleStarBtn">${url.starred ? '取消星标' : '设为星标'}</button>
                                <button class="detail-header-btn secondary" id="deleteUrlBtn">${context === 'starred' ? '从星标中删除' : '删除'}</button>
                                <button class="close-modal">&times;</button>
                            </div>
                        </div>
                        
                        <div class="detail-modal-body">
                            <!-- 部分一：网址详情 -->
                            <div class="detail-section-title">网址详情</div>
                            <div class="detail-row">
                                <strong>网址:</strong> 
                                <span>${url.url}</span>
                                <button class="copy-btn copy-url-detail-btn" data-url="${url.url}">复制</button>
                            </div>
                            <div class="detail-row">
                                <strong>名称:</strong> <span>${url.name}</span>
                            </div>
                            <div class="detail-row">
                                <strong>分类:</strong> <span>${this.getCategoryName(url.category)}</span>
                            </div>
                            <div class="detail-row">
                                <strong>星标:</strong> <span>${url.starred ? '是' : '否'}</span>
                            </div>
                            ${url.account ? `
                            <div class="detail-row">
                                <strong>账号:</strong> <span>${url.account}</span>
                                <button class="copy-btn" data-copy="account">复制</button>
                            </div>
                            ` : ''}
                            ${url.password ? `
                            <div class="detail-row">
                                <strong>密码:</strong> 
                                <span id="passwordDisplay">${'•'.repeat(url.password.length)}</span>
                                <button class="password-toggle" id="togglePasswordBtn">显示</button>
                                <button class="copy-btn" data-copy="password">复制</button>
                            </div>
                            ` : ''}
                            ${url.description ? `
                            <div class="detail-row">
                                <strong>描述:</strong> <span>${url.description}</span>
                            </div>
                            ` : ''}
                            
                            <!-- 部分二：绑定信息 -->
                            ${url.bindings && Object.keys(url.bindings).length > 0 ? `
                            <div class="detail-section-title">
                                <span>绑定信息：</span>
                                <button class="toggle-btn" id="toggleBindingsBtn">${bindingsExpanded ? '合并' : '展开'}</button>
                            </div>
                            <div id="bindingsSection" style="${bindingsExpanded ? '' : 'display: none;'}">
                                ${bindingsHTML}
                            </div>
                            ` : ''}
                            
                            <!-- 部分三：子网址 -->
                            ${url.subUrls && url.subUrls.length > 0 ? `
                            <div class="detail-section-title">
                                <span>子网址：</span>
                                <button class="toggle-btn" id="toggleSubUrlsBtn">${subUrlsExpanded ? '合并' : '展开'}</button>
                            </div>
                            <div id="subUrlsSection" style="${subUrlsExpanded ? '' : 'display: none;'}">
                                <div class="sub-url-detail">
                                    ${subUrlsHTML}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 访问按钮
                modal.querySelector('#visitUrlBtn').addEventListener('click', function() {
                    window.open(url.url, '_blank');
                });
                
                // 编辑按钮
                modal.querySelector('#editUrlBtn').addEventListener('click', function() {
                    modal.remove();
                    app.editUrl(url);
                });
                
                // 星标切换按钮
                modal.querySelector('#toggleStarBtn').addEventListener('click', function() {
                    url.starred = !url.starred;
                    app.saveData();
                    app.renderUrls();
                    app.updateStarredSection();
                    app.renderCategories();
                    modal.remove();
                    app.showToast(`已${url.starred ? '设为星标' : '取消星标'}`, 'success');
                    addLog(url.starred ? '设为星标' : '取消星标', `网址: ${url.name}`, 'info');
                });
                
                // 删除按钮
                modal.querySelector('#deleteUrlBtn').addEventListener('click', function() {
                    if (context === 'starred') {
                        // 从星标中删除：仅取消星标，不删除网址
                        if (confirm('确定要从星标中删除这个网址吗？')) {
                            url.starred = false;
                            app.saveData();
                            app.renderUrls();
                            app.updateStarredSection();
                            app.renderCategories();
                            modal.remove();
                            app.showToast('网址已从星标中移除', 'success');
                            addLog('取消星标', `网址: ${url.name}`, 'info');
                        }
                    } else {
                        // 普通删除：标记为删除
                        if (confirm('确定要删除这个网址吗？')) {
                            url.deleted = true;
                            url.deletedAt = new Date().toISOString();
                            app.saveData();
                            app.renderUrls();
                            app.updateStarredSection();
                            app.renderCategories();
                            modal.remove();
                            app.showToast('网址已删除', 'success');
                            addLog('删除网址', `网址: ${url.name}`, 'warning');
                        }
                    }
                });
                
                // 密码显示/隐藏功能
                if (url.password) {
                    const togglePasswordBtn = modal.querySelector('#togglePasswordBtn');
                    const passwordDisplay = modal.querySelector('#passwordDisplay');
                    
                    const showPassword = () => {
                        passwordDisplay.textContent = url.password;
                        togglePasswordBtn.textContent = '隐藏';
                        passwordVisible = true;
                        
                        // 10秒后自动隐藏密码
                        if (passwordHideTimer) {
                            clearTimeout(passwordHideTimer);
                        }
                        passwordHideTimer = setTimeout(() => {
                            hidePassword();
                        }, 10000);
                    };
                    
                    const hidePassword = () => {
                        passwordDisplay.textContent = '•'.repeat(url.password.length);
                        togglePasswordBtn.textContent = '显示';
                        passwordVisible = false;
                    };
                    
                    togglePasswordBtn.addEventListener('click', function() {
                        if (passwordVisible) {
                            hidePassword();
                        } else {
                            showPassword();
                        }
                    });
                }
                
                // 绑定信息展开/合并
                if (url.bindings && Object.keys(url.bindings).length > 0) {
                    const toggleBindingsBtn = modal.querySelector('#toggleBindingsBtn');
                    const bindingsSection = modal.querySelector('#bindingsSection');
                    
                    toggleBindingsBtn.addEventListener('click', function() {
                        if (bindingsSection.style.display === 'none') {
                            bindingsSection.style.display = 'block';
                            toggleBindingsBtn.textContent = '合并';
                            app.currentState.detailExpanded.bindings = true;
                        } else {
                            bindingsSection.style.display = 'none';
                            toggleBindingsBtn.textContent = '展开';
                            app.currentState.detailExpanded.bindings = false;
                        }
                    });
                }
                
                // 子网址展开/合并
                if (url.subUrls && url.subUrls.length > 0) {
                    const toggleSubUrlsBtn = modal.querySelector('#toggleSubUrlsBtn');
                    const subUrlsSection = modal.querySelector('#subUrlsSection');
                    
                    toggleSubUrlsBtn.addEventListener('click', function() {
                        if (subUrlsSection.style.display === 'none') {
                            subUrlsSection.style.display = 'block';
                            toggleSubUrlsBtn.textContent = '合并';
                            app.currentState.detailExpanded.subUrls = true;
                        } else {
                            subUrlsSection.style.display = 'none';
                            toggleSubUrlsBtn.textContent = '展开';
                            app.currentState.detailExpanded.subUrls = false;
                        }
                    });
                }
                
                // 复制主网址
                modal.querySelector('.copy-url-detail-btn').addEventListener('click', function() {
                    const urlToCopy = this.dataset.url;
                    navigator.clipboard.writeText(urlToCopy).then(() => {
                        app.showToast('网址已复制到剪贴板', 'success');
                    });
                });
                
                // 复制子网址和访问子网址
                modal.querySelectorAll('.copy-sub-url-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const subUrl = this.dataset.url;
                        navigator.clipboard.writeText(subUrl).then(() => {
                            app.showToast('子网址已复制到剪贴板', 'success');
                        });
                    });
                });
                
                modal.querySelectorAll('.visit-sub-url-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const subUrl = this.dataset.url;
                        window.open(subUrl, '_blank');
                    });
                });
                
                // 复制账号密码
                modal.querySelectorAll('.copy-btn').forEach(btn => {
                    const type = btn.dataset.copy;
                    if (type === 'account' || type === 'password') {
                        btn.addEventListener('click', function() {
                            const text = type === 'account' ? url.account : url.password;
                            if (text) {
                                navigator.clipboard.writeText(text).then(() => {
                                    app.showToast(`${type === 'account' ? '账号' : '密码'}已复制`, 'success');
                                });
                            }
                        });
                    }
                });
                
                // 关闭按钮
                modal.querySelector('.close-modal').addEventListener('click', function() {
                    if (passwordHideTimer) {
                        clearTimeout(passwordHideTimer);
                    }
                    modal.remove();
                });
                
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        if (passwordHideTimer) {
                            clearTimeout(passwordHideTimer);
                        }
                        modal.remove();
                    }
                });
            },
            
            // 编辑网址 - 支持子网址
            editUrl: function(url) {
                const el = this.elements;
                if (!el.formActionTitle || !el.saveUrlBtn) return;
                
                this.showAddUrlForm();
                this.currentState.editingUrl = url;
                
                el.formActionTitle.textContent = '编辑网址';
                el.saveUrlBtn.textContent = '更新网址';
                
                const urlInput = document.getElementById('url');
                const nameInput = document.getElementById('name');
                const iconUrlInput = document.getElementById('iconUrl');
                const accountInput = document.getElementById('account');
                const passwordInput = document.getElementById('password');
                const descriptionInput = document.getElementById('description');
                
                if (urlInput) urlInput.value = url.url;
                if (nameInput) nameInput.value = url.name;
                
                // 设置分类名称
                const categoryName = this.getCategoryName(url.category);
                if (el.categoryInput) el.categoryInput.value = categoryName;
                
                if (iconUrlInput) {
                    iconUrlInput.value = url.icon.startsWith('http') ? url.icon : '';
                }
                if (accountInput) accountInput.value = url.account || '';
                if (passwordInput) passwordInput.value = url.password || '';
                if (descriptionInput) descriptionInput.value = url.description || '';
                
                if (el.starToggle) {
                    const starIcon = el.starToggle.querySelector('i');
                    if (starIcon) {
                        if (url.starred) {
                            starIcon.classList.remove('far');
                            starIcon.classList.add('fas');
                            el.starToggle.classList.add('active');
                        } else {
                            starIcon.classList.remove('fas');
                            starIcon.classList.add('far');
                            el.starToggle.classList.remove('active');
                        }
                    }
                }
                
                // 设置子网址
                if (url.subUrls && url.subUrls.length > 0) {
                    if (el.subUrlsList) el.subUrlsList.innerHTML = '';
                    
                    url.subUrls.forEach(subUrl => {
                        const subUrlId = this.subUrlCounter++;
                        const subUrlRow = document.createElement('div');
                        subUrlRow.className = 'sub-url-row';
                        subUrlRow.dataset.id = subUrlId;
                        subUrlRow.innerHTML = `
                            <input type="text" class="sub-url-name-input" placeholder="子网址名称" data-id="${subUrlId}" value="${subUrl.name}">
                            <input type="url" class="sub-url-input" placeholder="子网址网址" data-id="${subUrlId}" value="${subUrl.url}">
                            <button class="sub-url-delete-btn" data-id="${subUrlId}" type="button">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        
                        el.subUrlsList.appendChild(subUrlRow);
                        
                        // 绑定删除按钮事件
                        const deleteBtn = subUrlRow.querySelector('.sub-url-delete-btn');
                        deleteBtn.addEventListener('click', () => {
                            subUrlRow.remove();
                            
                            // 如果没有子网址了，隐藏容器
                            if (el.subUrlsList.children.length === 0) {
                                el.subUrlsContainer.classList.add('hidden');
                            }
                        });
                    });
                    
                    if (el.subUrlsContainer) el.subUrlsContainer.classList.remove('hidden');
                }
                
                this.resetBindingInputs();
                if (url.bindings) {
                    if (url.bindings.phone) {
                        if (el.bindPhoneCheckbox) el.bindPhoneCheckbox.checked = true;
                        const phoneValue = document.getElementById('phoneValue');
                        if (phoneValue) phoneValue.value = url.bindings.phone;
                        if (el.phoneInputs) el.phoneInputs.classList.add('active');
                    }
                    if (url.bindings.email) {
                        if (el.bindEmailCheckbox) el.bindEmailCheckbox.checked = true;
                        const emailValue = document.getElementById('emailValue');
                        if (emailValue) emailValue.value = url.bindings.email;
                        if (el.emailInputs) el.emailInputs.classList.add('active');
                    }
                    if (url.bindings.wechat) {
                        if (el.bindWechatCheckbox) el.bindWechatCheckbox.checked = true;
                        const wechatValue = document.getElementById('wechatValue');
                        if (wechatValue) wechatValue.value = url.bindings.wechat;
                        if (el.wechatInputs) el.wechatInputs.classList.add('active');
                    }
                    if (url.bindings.qq) {
                        if (el.bindQQCheckbox) el.bindQQCheckbox.checked = true;
                        const qqValue = document.getElementById('qqValue');
                        if (qqValue) qqValue.value = url.bindings.qq;
                        if (el.qqInputs) el.qqInputs.classList.add('active');
                    }
                    if (url.bindings.realname) {
                        if (el.bindRealnameCheckbox) el.bindRealnameCheckbox.checked = true;
                        const realnameStatus = url.bindings.realname === '已实名' ? 'verified' : 'unverified';
                        const radio = document.querySelector(`input[name="realnameStatus"][value="${realnameStatus}"]`);
                        if (radio) radio.checked = true;
                        if (el.realnameInputs) el.realnameInputs.classList.add('active');
                    }
                    if (url.bindings.other) {
                        if (el.bindOtherCheckbox) el.bindOtherCheckbox.checked = true;
                        const otherValue = document.getElementById('otherValue');
                        if (otherValue) otherValue.value = url.bindings.other;
                        if (el.otherInputs) el.otherInputs.classList.add('active');
                    }
                }
                
                this.testIconUrl();
            },
            
            // 切换主题
            toggleTheme: function() {
                const el = this.elements;
                if (!el.themeBtn) return;
                
                this.userData.settings.darkMode = !this.userData.settings.darkMode;
                
                if (this.userData.settings.darkMode) {
                    document.body.classList.add('dark-mode');
                    el.themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                    el.themeBtn.title = '切换到亮色模式';
                } else {
                    document.body.classList.remove('dark-mode');
                    el.themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                    el.themeBtn.title = '切换到暗色模式';
                }
                
                const theme = this.userData.settings.darkMode ? '暗色' : '亮色';
                addLog('切换主题', `切换到${theme}模式`, 'info');
                
                this.saveData();
            },
            
            // 切换排序模式
            toggleSorting: function() {
                const el = this.elements;
                if (!el.sortBtn) return;
                
                this.userData.settings.sortingEnabled = !this.userData.settings.sortingEnabled;
                this.currentState.sortingEnabled = this.userData.settings.sortingEnabled;
                
                if (this.currentState.sortingEnabled) {
                    el.sortBtn.innerHTML = '<i class="fas fa-unlock"></i>';
                    el.sortBtn.title = '锁定排序';
                    this.showToast('已开启网址排序，可以拖拽网址调整顺序', 'info');
                    this.initSortable();
                } else {
                    el.sortBtn.innerHTML = '<i class="fas fa-lock"></i>';
                    el.sortBtn.title = '开启排序';
                    this.showToast('已锁定网址排序', 'info');
                    if (this.sortableInstance) {
                        this.sortableInstance.destroy();
                        this.sortableInstance = null;
                    }
                }
                
                const sorting = this.currentState.sortingEnabled ? '开启' : '关闭';
                addLog('排序设置', `${sorting}网址拖拽排序`, 'info');
                
                this.saveData();
            },
            
            // 批量删除网址
            batchDeleteUrls: function() {
                if (this.currentState.selectedUrls.length === 0) {
                    this.showToast('请先选择要删除的网址', 'warning');
                    return;
                }
                
                // 检查是否全部是星标网址
                const allStarred = this.currentState.selectedUrls.every(id => {
                    const url = this.userData.urls.find(u => u.id === id);
                    return url && url.starred;
                });
                
                if (allStarred) {
                    // 从星标中删除：仅取消星标
                    if (confirm(`确定要从星标中删除选中的 ${this.currentState.selectedUrls.length} 个网址吗？`)) {
                        this.userData.urls.forEach(url => {
                            if (this.currentState.selectedUrls.includes(url.id)) {
                                url.starred = false;
                            }
                        });
                        
                        this.currentState.selectedUrls = [];
                        
                        this.saveData();
                        this.renderCategories();
                        this.renderUrls();
                        this.updateStarredSection();
                        this.updateBatchButtons();
                        
                        this.showToast('网址已从星标中移除', 'success');
                        addLog('批量操作', `从星标中删除${this.currentState.selectedUrls.length}个网址`, 'info');
                    }
                } else {
                    // 普通删除：标记为删除
                    if (confirm(`确定要删除选中的 ${this.currentState.selectedUrls.length} 个网址吗？`)) {
                        this.userData.urls.forEach(url => {
                            if (this.currentState.selectedUrls.includes(url.id)) {
                                url.deleted = true;
                                url.deletedAt = new Date().toISOString();
                            }
                        });
                        
                        this.currentState.selectedUrls = [];
                        
                        this.saveData();
                        this.renderCategories();
                        this.renderUrls();
                        this.updateStarredSection();
                        this.updateBatchButtons();
                        
                        this.showToast('网址已删除', 'success');
                        addLog('批量操作', `删除了${this.currentState.selectedUrls.length}个网址`, 'warning');
                    }
                }
            },
            
            // 批量移动网址
            batchMoveUrls: function() {
                const app = this;
                if (this.currentState.selectedUrls.length === 0) {
                    this.showToast('请先选择要移动的网址', 'warning');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3>批量移动网址</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>请选择要移动到的分类：</p>
                            <input type="text" class="form-input" id="targetCategorySelect" list="batchCategoryList" placeholder="输入或选择分类">
                            <datalist id="batchCategoryList">
                                ${this.userData.categories.filter(c => c.id !== 'all').map(c => 
                                    `<option value="${c.name}">${c.name}</option>`
                                ).join('')}
                            </datalist>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelMoveBtn">取消</button>
                            <button class="btn btn-primary" id="confirmMoveBtn">移动</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.querySelector('#cancelMoveBtn').addEventListener('click', function() {
                    modal.remove();
                });
                
                modal.querySelector('#confirmMoveBtn').addEventListener('click', function() {
                    const targetCategoryName = modal.querySelector('#targetCategorySelect').value.trim();
                    
                    if (!targetCategoryName) {
                        app.showToast('请选择或输入分类', 'error');
                        return;
                    }
                    
                    let targetCategoryId = app.getCategoryIdByName(targetCategoryName);
                    
                    if (!targetCategoryId) {
                        // 创建新分类
                        const newCategory = {
                            id: 'category_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: targetCategoryName,
                            parentId: null,
                            order: app.userData.categories.filter(c => c.parentId === null && c.id !== 'all').length,
                            level: 1,
                            expanded: true
                        };
                        
                        app.userData.categories.push(newCategory);
                        targetCategoryId = newCategory.id;
                        
                        app.showToast(`已创建新分类"${targetCategoryName}"`, 'success');
                    }
                    
                    app.userData.urls.forEach(url => {
                        if (app.currentState.selectedUrls.includes(url.id)) {
                            url.category = targetCategoryId;
                        }
                    });
                    
                    app.saveData();
                    app.currentState.selectedUrls = [];
                    app.renderCategories();
                    app.renderUrls();
                    app.updateBatchButtons();
                    
                    modal.remove();
                    app.showToast(`网址已移动到"${targetCategoryName}"分类`, 'success');
                    addLog('批量移动', `移动${app.currentState.selectedUrls.length}个网址到"${targetCategoryName}"`);
                });
                
                modal.querySelector('.close-modal').addEventListener('click', function() {
                    modal.remove();
                });
                
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            },
            
            // 获取当前分类下的网址
            getCurrentUrls: function() {
                let filteredUrls = this.userData.urls.filter(url => !url.deleted);
                if (this.currentState.selectedCategory !== 'all') {
                    const categoryIds = [this.currentState.selectedCategory];
                    const subCategories = this.userData.categories.filter(c => c.parentId === this.currentState.selectedCategory);
                    subCategories.forEach(sub => categoryIds.push(sub.id));
                    
                    filteredUrls = filteredUrls.filter(url => categoryIds.includes(url.category));
                }
                return filteredUrls;
            },
            
            // 显示新增分类模态框
            showAddCategoryModal: function() {
                const el = this.elements;
                if (!el.categoryModalTitle || !el.categoryNameInput) return;
                
                el.categoryModalTitle.textContent = '新增分类';
                el.categoryNameInput.value = '';
                if (el.parentCategorySelect) el.parentCategorySelect.value = '';
                this.currentState.editingCategory = null;
                if (el.categoryModal) el.categoryModal.classList.add('active');
            },
            
            // 隐藏分类模态框
            hideCategoryModal: function() {
                const el = this.elements;
                if (el.categoryModal) el.categoryModal.classList.remove('active');
            },
            
            // 保存分类
            saveCategory: function() {
                const el = this.elements;
                if (!el.categoryNameInput) return;
                
                const name = el.categoryNameInput.value.trim();
                const parentId = el.parentCategorySelect ? (el.parentCategorySelect.value || null) : null;
                
                if (!name) {
                    this.showToast('分类名称不能为空', 'error');
                    return;
                }
                
                const existingCategory = this.userData.categories.find(c => 
                    c.name === name && c.parentId === parentId && c.id !== this.currentState.editingCategory?.id
                );
                
                if (existingCategory) {
                    this.showToast('该分类名称已存在', 'error');
                    return;
                }
                
                if (this.currentState.editingCategory) {
                    this.currentState.editingCategory.name = name;
                    this.currentState.editingCategory.parentId = parentId;
                    this.showToast('分类已更新', 'success');
                    addLog('更新分类', `更新分类: ${name}`, 'success');
                } else {
                    const newCategory = {
                        id: 'category_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: name,
                        parentId: parentId,
                        order: this.userData.categories.filter(c => c.parentId === parentId).length,
                        level: parentId ? 2 : 1,
                        expanded: true
                    };
                    
                    this.userData.categories.push(newCategory);
                    this.showToast('分类已添加', 'success');
                    addLog('新增分类', `新增分类: ${name}`, 'success');
                }
                
                this.saveData();
                this.renderCategories();
                this.hideCategoryModal();
                
                // 自动同步到Gist
                setTimeout(() => this.syncToGist(), 1000);
            },
            
            // 编辑分类
            editCategory: function(category) {
                const el = this.elements;
                if (!el.categoryModalTitle || !el.categoryNameInput) return;
                
                el.categoryModalTitle.textContent = '编辑分类';
                el.categoryNameInput.value = category.name;
                if (el.parentCategorySelect) el.parentCategorySelect.value = category.parentId || '';
                this.currentState.editingCategory = category;
                if (el.categoryModal) el.categoryModal.classList.add('active');
            },
            
            // 删除分类
            deleteCategory: function(category) {
                if (category.id === 'all') {
                    this.showToast('不能删除"全部"分类', 'error');
                    return;
                }
                
                const hasSubcategories = this.userData.categories.some(c => c.parentId === category.id);
                if (hasSubcategories) {
                    this.showToast('请先删除该分类下的子分类', 'error');
                    return;
                }
                
                const hasUrls = this.userData.urls.some(url => !url.deleted && url.category === category.id);
                if (hasUrls) {
                    this.showToast('该分类下还有网址，无法删除', 'error');
                    return;
                }
                
                if (confirm(`确定要删除分类"${category.name}"吗？`)) {
                    const index = this.userData.categories.findIndex(c => c.id === category.id);
                    if (index !== -1) {
                        this.userData.categories.splice(index, 1);
                        
                        this.saveData();
                        this.renderCategories();
                        
                        this.showToast('分类已删除', 'success');
                        addLog('删除分类', `删除分类: ${category.name}`, 'warning');
                    }
                }
            },
            
            // 切换分类设置模式
            toggleCategorySettings: function() {
                const el = this.elements;
                if (!el.categorySettingsBtn) return;
                
                this.currentState.categorySettingsMode = !this.currentState.categorySettingsMode;
                
                if (this.currentState.categorySettingsMode) {
                    el.categorySettingsBtn.innerHTML = '<i class="fas fa-check"></i>';
                    el.categorySettingsBtn.title = '完成设置';
                    this.showToast('已进入分类设置模式', 'info');
                    addLog('分类设置', '进入分类设置模式');
                } else {
                    el.categorySettingsBtn.innerHTML = '<i class="fas fa-cog"></i>';
                    el.categorySettingsBtn.title = '分类设置';
                    this.showToast('已退出分类设置模式', 'info');
                    addLog('分类设置', '退出分类设置模式');
                }
                
                this.renderCategories();
                
                if (this.currentState.categorySettingsMode) {
                    this.initCategorySortable();
                } else {
                    if (this.categorySortableInstance) {
                        this.categorySortableInstance.destroy();
                        this.categorySortableInstance = null;
                    }
                    
                    Object.values(this.subcategorySortableInstances).forEach(instance => {
                        instance.destroy();
                    });
                    this.subcategorySortableInstances = {};
                }
            },
            
            // 初始化拖拽排序
            initSortable: function() {
                if (this.sortableInstance) {
                    this.sortableInstance.destroy();
                }
                
                if (this.currentState.batchMode) return;
                
                const urlsGrid = this.elements.urlsGrid;
                if (!urlsGrid) return;
                
                this.sortableInstance = new Sortable(urlsGrid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onEnd: (evt) => {
                        this.saveUrlOrder();
                    }
                });
            },
            
            // 初始化分类拖拽排序
            initCategorySortable: function() {
                if (this.categorySortableInstance) {
                    this.categorySortableInstance.destroy();
                }
                
                Object.values(this.subcategorySortableInstances).forEach(instance => {
                    instance.destroy();
                });
                this.subcategorySortableInstances = {};
                
                const sortableList = document.querySelector('.category-list');
                if (!sortableList) return;
                
                this.categorySortableInstance = new Sortable(sortableList, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    filter: '.category-item[data-id="all"]',
                    draggable: '.level-1',
                    onEnd: (evt) => {
                        this.saveCategoryOrder();
                    }
                });
                
                document.querySelectorAll('.subcategory-list').forEach(subList => {
                    const parentId = subList.dataset.parent;
                    this.subcategorySortableInstances[parentId] = new Sortable(subList, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        group: {
                            name: 'subcategories',
                            put: false,
                            pull: false
                        },
                        onEnd: (evt) => {
                            this.saveSubcategoryOrder(parentId);
                        }
                    });
                });
            },
            
            // 保存网址排序
            saveUrlOrder: function() {
                const urlCards = this.elements.urlsGrid.querySelectorAll('.url-card');
                const urlIds = Array.from(urlCards).map(card => parseInt(card.dataset.id));
                
                this.userData.urlOrder = urlIds;
                this.saveData();
                
                this.showToast('网址顺序已保存', 'success');
                addLog('网址排序', '拖拽调整网址顺序');
            },
            
            // 保存一级分类排序
            saveCategoryOrder: function() {
                const categoryItems = document.querySelectorAll('.category-item.level-1');
                
                categoryItems.forEach((item, index) => {
                    const categoryId = item.dataset.id;
                    const category = this.userData.categories.find(c => c.id === categoryId);
                    if (category) {
                        category.order = index;
                    }
                });
                
                this.saveData();
                this.showToast('分类顺序已保存', 'success');
                addLog('分类排序', '拖拽调整分类顺序');
            },
            
            // 保存二级分类排序
            saveSubcategoryOrder: function(parentId) {
                const subList = document.querySelector(`.subcategory-list[data-parent="${parentId}"]`);
                if (!subList) return;
                
                const subItems = subList.querySelectorAll('.category-item.level-2');
                
                // 获取所有二级分类
                const allSubcategories = this.userData.categories.filter(c => c.parentId === parentId);
                
                subItems.forEach((item, index) => {
                    const categoryId = item.dataset.id;
                    const category = allSubcategories.find(c => c.id === categoryId);
                    if (category) {
                        category.order = index;
                    }
                });
                
                this.saveData();
                this.showToast('子分类顺序已保存', 'success');
                addLog('子分类排序', '拖拽调整子分类顺序');
            },
            
            // 设置子分类容器的高度
            setSubcategoryListHeights: function() {
                document.querySelectorAll('.subcategory-list').forEach(list => {
                    if (!list.classList.contains('collapsed')) {
                        list.style.maxHeight = list.scrollHeight + 'px';
                    }
                });
            },
            
            // 获取分类名称
            getCategoryName: function(categoryId) {
                const category = this.userData.categories.find(c => c.id === categoryId);
                return category ? category.name : categoryId;
            },
            
            // 处理功能按钮点击
            handleFunctionClick: function(functionName) {
                switch(functionName) {
                    case 'notes':
                        this.showNotesPanel();
                        break;
                    case 'icons':
                        window.open('https://www.kdocs.cn/l/cvdLpFlzHyhc', '_blank');
                        break;
                    case 'datacenter':
                        this.showDataCenter();
                        break;
                    case 'logs':
                        this.showLogsModal();
                        break;
                    case 'recycle':
                        this.showRecycleBin();
                        break;
                }
            },
            
            // 导入数据
            importData: function() {
                const el = this.elements;
                if (!el.importFile) return;
                
                const app = this;
                const file = el.importFile.files[0];
                if (!file) {
                    this.showToast('请选择要导入的文件', 'warning');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.urls || !importedData.categories) {
                            throw new Error('数据格式不正确');
                        }
                        
                        // 完全替换现有数据，确保与源设备数据一致
                        app.userData = importedData;
                        
                        // 恢复上次选择的分类
                        if (app.userData.settings.lastSelectedCategory) {
                            app.currentState.selectedCategory = app.userData.settings.lastSelectedCategory;
                        }
                        
                        // 应用设置
                        if (app.userData.settings.darkMode) {
                            document.body.classList.add('dark-mode');
                            el.themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                            el.themeBtn.title = '切换到亮色模式';
                        } else {
                            document.body.classList.remove('dark-mode');
                            el.themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                            el.themeBtn.title = '切换到暗色模式';
                        }
                        
                        if (app.userData.settings.sortingEnabled) {
                            el.sortBtn.innerHTML = '<i class="fas fa-unlock"></i>';
                            el.sortBtn.title = '锁定排序';
                            app.currentState.sortingEnabled = true;
                        } else {
                            el.sortBtn.innerHTML = '<i class="fas fa-lock"></i>';
                            el.sortBtn.title = '开启排序';
                            app.currentState.sortingEnabled = false;
                        }
                        
                        app.saveData();
                        app.renderCategories();
                        app.renderUrls();
                        app.updateStarredSection();
                        
                        // 重新初始化便签管理器
                        app.notesManager = new NotesManager(app);
                        app.notesManager.init();
                        
                        app.showToast('数据导入成功，已完全恢复原设备数据状态', 'success');
                        addLog('数据导入', '从本地文件导入数据成功', 'success');
                    } catch (error) {
                        console.error('导入数据失败:', error);
                        app.showToast('导入数据失败，请检查文件格式', 'error');
                        addLog('数据导入', '导入失败: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            },
            
            // 导出数据 - 导出完整网站数据
            exportData: function() {
                try {
                    const exportData = {
                        urls: this.userData.urls,
                        notes: this.userData.notes,
                        categories: this.userData.categories,
                        settings: this.userData.settings,
                        exportDate: new Date().toISOString(),
                        version: '1.3',
                        appName: 'SPAN网址收藏'
                    };
                    
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const downloadLink = document.createElement('a');
                    const date = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    downloadLink.download = `SPAN完整备份_${date}.json`;
                    downloadLink.href = URL.createObjectURL(dataBlob);
                    downloadLink.click();
                    
                    URL.revokeObjectURL(downloadLink.href);
                    
                    this.showToast('完整数据导出成功，包含网址、便签、分类和设置', 'success');
                    addLog('数据导出', '导出完整数据到本地文件', 'success');
                } catch (error) {
                    console.error('导出数据失败:', error);
                    this.showToast('导出数据失败', 'error');
                    addLog('数据导出', '导出失败: ' + error.message, 'error');
                }
            },
            
            // 显示回收站
            showRecycleBin: function() {
                const el = this.elements;
                if (!el.functionsPanel || !el.recycleBinPanel) return;
                
                el.functionsPanel.classList.add('hidden');
                el.recycleBinPanel.classList.remove('hidden');
                el.recycleBinPanel.classList.add('active');
                el.addUrlForm.classList.add('hidden');
                el.urlsSection.classList.add('hidden');
                el.starredSection.classList.add('hidden');
                el.notesPanel.classList.add('hidden');
                el.dataCenterPanel.classList.add('hidden');
                this.currentState.view = 'recycle';
                
                this.renderRecycleBin();
            },
            
            // 渲染回收站
            renderRecycleBin: function() {
                const el = this.elements;
                if (!el.recycleItems) return;
                
                const app = this;
                const deletedUrls = this.userData.urls.filter(url => url.deleted);
                const deletedNotes = this.userData.notes.filter(note => note.deleted);
                
                el.recycleItems.innerHTML = '';
                
                if (deletedUrls.length === 0 && deletedNotes.length === 0) {
                    el.recycleItems.innerHTML = `
                        <div class="empty-state">
                            <i class="far fa-trash-alt"></i>
                            <h3>回收站为空</h3>
                            <p>已删除的网址和便签将出现在这里</p>
                        </div>
                    `;
                    return;
                }
                
                // 渲染已删除的网址
                deletedUrls.forEach(url => {
                    const recycleItem = document.createElement('div');
                    recycleItem.className = 'recycle-item';
                    recycleItem.innerHTML = `
                        <div class="recycle-item-info">
                            <div class="recycle-item-icon">
                                ${url.icon && url.icon.startsWith('http') ? 
                                    `<img src="${url.icon}" alt="${url.name}" onerror="app.handleRecycleIconError(this, '${url.name.charAt(0).toUpperCase()}')">` : 
                                    (url.icon || url.name.charAt(0).toUpperCase())}
                            </div>
                            <div>
                                <div class="recycle-item-name">${url.name} <span style="font-size: 12px; color: var(--primary-color); margin-left: 5px;">(网址)</span></div>
                                <div class="recycle-item-category">${this.getCategoryName(url.category)}</div>
                                <div style="font-size: 12px; color: var(--text-light); margin-top: 2px;">
                                    删除时间: ${this.formatDate(url.deletedAt)}
                                </div>
                            </div>
                        </div>
                        <div class="recycle-item-actions">
                            <button class="btn btn-secondary restore-btn" data-id="${url.id}" data-type="url">恢复</button>
                            <button class="btn btn-secondary delete-permanently-btn" data-id="${url.id}" data-type="url">永久删除</button>
                        </div>
                    `;
                    
                    el.recycleItems.appendChild(recycleItem);
                });
                
                // 渲染已删除的便签
                deletedNotes.forEach(note => {
                    const recycleItem = document.createElement('div');
                    recycleItem.className = 'recycle-item';
                    const contentPreview = note.content.length > 50 ? note.content.substring(0, 50) + '...' : note.content;
                    
                    recycleItem.innerHTML = `
                        <div class="recycle-item-info">
                            <div class="recycle-item-icon" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white;">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <div>
                                <div class="recycle-item-name">便签 <span style="font-size: 12px; color: var(--primary-color); margin-left: 5px;">(便签)</span></div>
                                <div class="recycle-item-category">${contentPreview || '空便签'}</div>
                                <div style="font-size: 12px; color: var(--text-light); margin-top: 2px;">
                                    删除时间: ${this.formatDate(note.deletedAt)} | 字符数: ${note.content.length}
                                </div>
                            </div>
                        </div>
                        <div class="recycle-item-actions">
                            <button class="btn btn-secondary restore-btn" data-id="${note.id}" data-type="note">恢复</button>
                            <button class="btn btn-secondary delete-permanently-btn" data-id="${note.id}" data-type="note">永久删除</button>
                        </div>
                    `;
                    
                    el.recycleItems.appendChild(recycleItem);
                });
                
                document.querySelectorAll('.restore-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.dataset.id);
                        const type = this.dataset.type;
                        if (type === 'url') {
                            app.restoreUrl(id);
                        } else {
                            app.restoreNote(id);
                        }
                    });
                });
                
                document.querySelectorAll('.delete-permanently-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.dataset.id);
                        const type = this.dataset.type;
                        if (type === 'url') {
                            app.deletePermanently(id, type);
                        } else {
                            app.deletePermanently(id, type);
                        }
                    });
                });
            },
            
            // 格式化日期
            formatDate: function(dateString) {
                if (!dateString) return '未知时间';
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN');
            },
            
            // 恢复网址
            restoreUrl: function(id) {
                const url = this.userData.urls.find(u => u.id === id);
                if (url) {
                    url.deleted = false;
                    url.deletedAt = null;
                    this.saveData();
                    this.renderRecycleBin();
                    this.renderCategories();
                    this.showToast('网址已恢复', 'success');
                    addLog('恢复网址', `恢复网址: ${url.name}`, 'success');
                }
            },
            
            // 恢复便签
            restoreNote: function(id) {
                const note = this.userData.notes.find(n => n.id === id);
                if (note) {
                    note.deleted = false;
                    note.deletedAt = null;
                    this.saveData();
                    this.renderRecycleBin();
                    if (this.notesManager) {
                        this.notesManager.renderNotes();
                    }
                    this.showToast('便签已恢复', 'success');
                    addLog('恢复便签', '恢复便签内容', 'success');
                }
            },
            
            // 永久删除
            deletePermanently: function(id, type) {
                const itemType = type === 'url' ? '网址' : '便签';
                const app = this;
                
                if (confirm(`确定要永久删除这个${itemType}吗？此操作不可撤销。`)) {
                    if (type === 'url') {
                        const index = app.userData.urls.findIndex(u => u.id === id);
                        if (index !== -1) {
                            const urlName = app.userData.urls[index].name;
                            app.userData.urls.splice(index, 1);
                            app.saveData();
                            app.renderRecycleBin();
                            app.renderCategories();
                            app.showToast('网址已永久删除', 'success');
                            addLog('永久删除', `永久删除网址: ${urlName}`, 'warning');
                        }
                    } else {
                        const index = app.userData.notes.findIndex(n => n.id === id);
                        if (index !== -1) {
                            app.userData.notes.splice(index, 1);
                            app.saveData();
                            app.renderRecycleBin();
                            if (app.notesManager) {
                                app.notesManager.renderNotes();
                            }
                            app.showToast('便签已永久删除', 'success');
                            addLog('永久删除', '永久删除便签', 'warning');
                        }
                    }
                }
            },
            
            // 清空回收站
            emptyRecycleBin: function() {
                const deletedUrlsCount = this.userData.urls.filter(url => url.deleted).length;
                const deletedNotesCount = this.userData.notes.filter(note => note.deleted).length;
                const totalCount = deletedUrlsCount + deletedNotesCount;
                
                if (totalCount === 0) {
                    this.showToast('回收站已为空', 'info');
                    return;
                }
                
                if (confirm(`确定要清空回收站吗？这将永久删除 ${totalCount} 个项目（${deletedUrlsCount} 个网址和 ${deletedNotesCount} 个便签），此操作不可撤销。`)) {
                    // 永久删除已标记为删除的网址
                    this.userData.urls = this.userData.urls.filter(url => !url.deleted);
                    
                    // 永久删除已标记为删除的便签
                    this.userData.notes = this.userData.notes.filter(note => !note.deleted);
                    
                    this.saveData();
                    this.renderRecycleBin();
                    this.renderCategories();
                    if (this.notesManager) {
                        this.notesManager.renderNotes();
                    }
                    this.showToast('回收站已清空', 'success');
                    addLog('清空回收站', `永久删除${totalCount}个项目`, 'warning');
                }
            },
            
            // 更新布局
            updateLayout: function() {
                // 响应式布局更新逻辑
            },
            
            // 显示消息提示 - 修复：使用独立的showToast函数
            showToast: function(message, type = 'info') {
                showToast(message, type);
            },
            
            // 显示操作日志模态框
            showLogsModal: function() {
                const el = this.elements;
                if (el.logsModal) el.logsModal.classList.add('active');
                this.renderLogs();
            },
            
            // 隐藏操作日志模态框
            hideLogsModal: function() {
                const el = this.elements;
                if (el.logsModal) el.logsModal.classList.remove('active');
            },
            
            // 渲染操作日志
            renderLogs: function() {
                const el = this.elements;
                if (!el.logsContainer) return;
                
                el.logsContainer.innerHTML = '';
                
                if (operationLogs.length === 0) {
                    el.logsContainer.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <i class="fas fa-history"></i>
                            <p>暂无操作记录</p>
                        </div>
                    `;
                    return;
                }
                
                operationLogs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = 'log-item';
                    logElement.style.cssText = `
                        padding: 10px;
                        margin-bottom: 8px;
                        border-radius: 6px;
                        background: var(--card-color);
                        border-left: 4px solid ${this.getLogTypeColor(log.type)};
                        font-size: 14px;
                    `;
                    
                    const time = formatLogTime(log.timestamp);
                    const typeIcon = this.getLogTypeIcon(log.type);
                    
                    logElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: 500;">${log.action}</span>
                            <span style="color: var(--text-light); font-size: 12px;">${time}</span>
                        </div>
                        <div style="color: var(--text-light); font-size: 13px;">
                            <span style="color: ${this.getLogTypeColor(log.type)}; margin-right: 8px;">
                                <i class="fas ${typeIcon}"></i>
                            </span>
                            ${log.details}
                        </div>
                    `;
                    
                    el.logsContainer.appendChild(logElement);
                });
            },
            
            // 获取日志类型颜色
            getLogTypeColor: function(type) {
                switch(type) {
                    case 'success': return '#2ecc71';
                    case 'error': return '#e74c3c';
                    case 'warning': return '#f39c12';
                    default: return 'var(--primary-color)';
                }
            },
            
            // 获取日志类型图标
            getLogTypeIcon: function(type) {
                switch(type) {
                    case 'success': return 'fa-check-circle';
                    case 'error': return 'fa-exclamation-circle';
                    case 'warning': return 'fa-exclamation-triangle';
                    default: return 'fa-info-circle';
                }
            },
            
            // 清空操作日志
            clearLogs: function() {
                if (operationLogs.length === 0) {
                    this.showToast('日志已为空', 'info');
                    return;
                }
                
                if (confirm('确定要清空所有操作日志吗？此操作不可撤销。')) {
                    operationLogs = [];
                    localStorage.removeItem('span_operation_logs');
                    this.renderLogs();
                    this.showToast('操作日志已清空', 'success');
                    addLog('清空日志', '用户清空了所有操作日志', 'warning');
                }
            },
            
            // 更新同步设置显示
            updateSyncSettingsDisplay: function() {
                const el = this.elements;
                
                // 更新同步间隔选择
                if (el.syncInterval) {
                    const interval = this.userData.settings.syncInterval || 15;
                    el.syncInterval.value = interval;
                }
                
                // 更新Token状态
                if (el.currentTokenStatus) {
                    const token = localStorage.getItem('github_token');
                    if (token) {
                        el.currentTokenStatus.innerHTML = `
                            <span style="color: var(--accent-color);">
                                <i class="fas fa-check-circle"></i> Token已设置
                            </span>
                            <div style="font-size: 12px; margin-top: 5px; color: var(--text-light);">
                                ${token.substring(0, 8)}...${token.substring(token.length - 4)}
                            </div>
                        `;
                    } else {
                        el.currentTokenStatus.innerHTML = `
                            <span style="color: #e74c3c;">
                                <i class="fas fa-exclamation-circle"></i> 未设置Token
                            </span>
                        `;
                    }
                }
            },
            
            // 更新上次同步时间显示
            updateLastSyncTime: function() {
                const el = this.elements;
                if (!el.lastSyncTime) return;
                
                const lastSync = localStorage.getItem('last_sync_time');
                if (lastSync) {
                    const date = new Date(lastSync);
                    el.lastSyncTime.textContent = `上次同步: ${date.toLocaleString('zh-CN')}`;
                } else {
                    el.lastSyncTime.textContent = '从未同步';
                }
            },
            
            // 保存同步设置
            saveSyncSettings: function() {
                const el = this.elements;
                if (!el.syncInterval) return;
                
                const interval = parseInt(el.syncInterval.value);
                
                this.userData.settings.syncInterval = interval;
                this.saveData();
                
                // 重启同步定时器
                this.initSyncTimer();
                
                this.showToast(`自动同步间隔已设置为${interval === 0 ? '关闭' : interval + '分钟'}`, 'success');
                addLog('同步设置', `自动同步间隔设置为${interval === 0 ? '关闭' : interval + '分钟'}`);
            },
            
            // 初始化同步定时器
            initSyncTimer: function() {
                if (syncTimer) {
                    clearInterval(syncTimer);
                    syncTimer = null;
                }
                
                const interval = this.userData.settings.syncInterval || 15;
                
                if (interval > 0 && window.userToken && userGistId) {
                    // 转换为毫秒
                    const intervalMs = interval * 60 * 1000;
                    
                    syncTimer = setInterval(() => {
                        if (isOnline) {
                            this.syncToGist();
                        }
                    }, intervalMs);
                    
                    console.log(`自动同步已启用，间隔: ${interval}分钟`);
                    addLog('同步定时器', `自动同步定时器已启动，间隔${interval}分钟`);
                }
            },
            
            // 同步数据到Gist - 修复401错误
            async syncToGist() {
                if (!window.userToken || !userGistId) {
                    this.showToast('未设置Token或Gist ID', 'error');
                    addLog('Gist同步', '同步失败：未设置Token或Gist ID', 'error');
                    return;
                }
                
                if (!isOnline) {
                    this.showToast('当前处于离线状态，无法同步', 'warning');
                    return;
                }
                
                try {
                    this.showToast('正在同步到Gist...', 'info');
                    
                    // 准备要同步的数据
                    const dataToSync = {
                        ...this.userData,
                        logs: operationLogs,
                        lastSync: new Date().toISOString()
                    };
                    
                    // 尝试使用Bearer授权，如果失败则使用token前缀
                    const tokenPrefixes = ['Bearer', 'token'];
                    let response = null;
                    let lastError = null;
                    
                    for (let prefix of tokenPrefixes) {
                        try {
                            response = await fetch(`https://api.github.com/gists/${userGistId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Authorization': `${prefix} ${window.userToken}`,
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/vnd.github.v3+json'
                                },
                                body: JSON.stringify({
                                    description: 'SPAN_BOOKMARKS_DATA_STORAGE',
                                    files: {
                                        'data.json': {
                                            content: JSON.stringify(dataToSync, null, 2)
                                        }
                                    }
                                })
                            });
                            
                            if (response.ok) break;
                            
                            const errorData = await response.json().catch(() => ({}));
                            lastError = new Error(`同步失败 (${prefix}): ${response.status} - ${errorData.message || '未知错误'}`);
                            
                        } catch (err) {
                            lastError = err;
                        }
                    }
                    
                    if (!response || !response.ok) {
                        throw lastError || new Error('同步失败：未知错误');
                    }
                    
                    // 更新上次同步时间
                    const now = new Date().toISOString();
                    localStorage.setItem('last_sync_time', now);
                    
                    this.showToast('数据已同步到Gist', 'success');
                    addLog('Gist同步', '数据成功同步到Gist', 'success');
                    
                    // 更新显示
                    this.updateLastSyncTime();
                    
                } catch (error) {
                    console.error('同步失败:', error);
                    
                    // 检查是否是Token过期或无效
                    if (error.message.includes('401') || error.message.includes('Bad credentials')) {
                        this.showToast('Token已过期或无效，请更新Token', 'error');
                        // 清空无效的Token
                        localStorage.removeItem('github_token');
                        localStorage.removeItem('user_gist_id');
                        window.userToken = null;
                        userGistId = null;
                        this.updateSyncSettingsDisplay();
                    } else {
                        this.showToast('同步失败: ' + error.message, 'error');
                    }
                    
                    addLog('Gist同步', '同步失败: ' + error.message, 'error');
                }
            },
            
            // 从Gist加载数据 - 修复401错误
            async loadDataFromGist() {
                if (!window.userToken || !userGistId) {
                    this.showToast('未设置Token或Gist ID', 'error');
                    return;
                }
                
                if (!isOnline) {
                    this.showToast('当前处于离线状态，无法从Gist加载', 'warning');
                    return;
                }
                
                try {
                    this.showToast('正在从Gist加载数据...', 'info');
                    
                    // 尝试使用Bearer授权，如果失败则使用token前缀
                    const tokenPrefixes = ['Bearer', 'token'];
                    let response = null;
                    let lastError = null;
                    
                    for (let prefix of tokenPrefixes) {
                        try {
                            response = await fetch(`https://api.github.com/gists/${userGistId}`, {
                                headers: {
                                    'Authorization': `${prefix} ${window.userToken}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            
                            if (response.ok) break;
                            
                            const errorData = await response.json().catch(() => ({}));
                            lastError = new Error(`加载失败 (${prefix}): ${response.status} - ${errorData.message || '未知错误'}`);
                            
                        } catch (err) {
                            lastError = err;
                        }
                    }
                    
                    if (!response || !response.ok) {
                        throw lastError || new Error('加载失败：未知错误');
                    }
                    
                    const gist = await response.json();
                    const fileContent = gist.files['data.json'].content;
                    const importedData = JSON.parse(fileContent);
                    
                    if (!importedData.urls || !importedData.categories) {
                        throw new Error('Gist数据格式不正确');
                    }
                    
                    // 加载操作日志
                    if (importedData.logs && Array.isArray(importedData.logs)) {
                        operationLogs = importedData.logs;
                        localStorage.setItem('span_operation_logs', JSON.stringify(operationLogs));
                    }
                    
                    // 完全替换现有数据
                    this.userData = importedData;
                    
                    // 恢复设置
                    if (this.userData.settings.lastSelectedCategory) {
                        this.currentState.selectedCategory = this.userData.settings.lastSelectedCategory;
                    }
                    
                    // 应用主题设置
                    if (this.userData.settings.darkMode) {
                        document.body.classList.add('dark-mode');
                        this.elements.themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                        this.elements.themeBtn.title = '切换到亮色模式';
                    } else {
                        document.body.classList.remove('dark-mode');
                        this.elements.themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                        this.elements.themeBtn.title = '切换到暗色模式';
                    }
                    
                    // 应用排序设置
                    if (this.userData.settings.sortingEnabled) {
                        this.elements.sortBtn.innerHTML = '<i class="fas fa-unlock"></i>';
                        this.elements.sortBtn.title = '锁定排序';
                        this.currentState.sortingEnabled = true;
                    } else {
                        this.elements.sortBtn.innerHTML = '<i class="fas fa-lock"></i>';
                        this.elements.sortBtn.title = '开启排序';
                        this.currentState.sortingEnabled = false;
                    }
                    
                    this.saveData();
                    this.renderCategories();
                    this.renderUrls();
                    this.updateStarredSection();
                    
                    // 重新初始化便签管理器
                    this.notesManager = new NotesManager(this);
                    this.notesManager.init();
                    
                    // 更新同步时间
                    localStorage.setItem('last_sync_time', new Date().toISOString());
                    this.updateLastSyncTime();
                    
                    this.showToast('已从Gist加载最新数据', 'success');
                    addLog('Gist加载', '从Gist成功加载数据', 'success');
                    
                } catch (error) {
                    console.error('从Gist加载数据失败:', error);
                    
                    // 检查是否是Token过期或无效
                    if (error.message.includes('401') || error.message.includes('Bad credentials')) {
                        this.showToast('Token已过期或无效，请重新连接', 'error');
                        // 清空无效的Token
                        localStorage.removeItem('github_token');
                        localStorage.removeItem('user_gist_id');
                        window.userToken = null;
                        userGistId = null;
                        this.updateSyncSettingsDisplay();
                    } else {
                        this.showToast('从Gist加载数据失败: ' + error.message, 'error');
                    }
                    
                    addLog('Gist加载', '从Gist加载数据失败: ' + error.message, 'error');
                }
            },
            
            // 测试Token
            async testToken() {
                const el = this.elements;
                if (!el.newTokenInput) return;
                
                const token = el.newTokenInput.value.trim();
                
                if (!token) {
                    this.showToast('请输入Token', 'warning');
                    return;
                }
                
                try {
                    this.showToast('正在测试Token...', 'info');
                    
                    // 尝试两种授权方式
                    const tokenPrefixes = ['Bearer', 'token'];
                    let response = null;
                    let lastError = null;
                    
                    for (let prefix of tokenPrefixes) {
                        try {
                            response = await fetch('https://api.github.com/user', {
                                headers: { 
                                    'Authorization': `${prefix} ${token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            
                            if (response.ok) break;
                            
                            const errorData = await response.json().catch(() => ({}));
                            lastError = new Error(`Token无效 (${prefix}): ${response.status} - ${errorData.message || '未知错误'}`);
                            
                        } catch (err) {
                            lastError = err;
                        }
                    }
                    
                    if (!response || !response.ok) {
                        throw lastError || new Error('Token无效或权限不足');
                    }
                    
                    this.showToast('Token测试成功', 'success');
                    addLog('Token测试', 'Token测试成功');
                    
                } catch (error) {
                    console.error('Token测试失败:', error);
                    this.showToast('Token测试失败: ' + error.message, 'error');
                    addLog('Token测试', 'Token测试失败: ' + error.message, 'error');
                }
            },
            
            // 更新Token
            async updateToken() {
                const el = this.elements;
                if (!el.newTokenInput) return;
                
                const token = el.newTokenInput.value.trim();
                
                if (!token) {
                    this.showToast('请输入新的Token', 'warning');
                    return;
                }
                
                try {
                    // 测试Token有效性
                    this.showToast('正在验证Token...', 'info');
                    
                    const tokenPrefixes = ['Bearer', 'token'];
                    let response = null;
                    let lastError = null;
                    
                    for (let prefix of tokenPrefixes) {
                        try {
                            response = await fetch('https://api.github.com/user', {
                                headers: { 
                                    'Authorization': `${prefix} ${token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            
                            if (response.ok) break;
                            
                            const errorData = await response.json().catch(() => ({}));
                            lastError = new Error(`Token无效 (${prefix}): ${response.status} - ${errorData.message || '未知错误'}`);
                            
                        } catch (err) {
                            lastError = err;
                        }
                    }
                    
                    if (!response || !response.ok) {
                        throw lastError || new Error('Token无效或权限不足');
                    }
                    
                    // 更新Token
                    window.userToken = token;
                    localStorage.setItem('github_token', token);
                    
                    // 尝试查找或创建Gist
                    let gistsResponse = null;
                    let gists = null;
                    
                    for (let prefix of tokenPrefixes) {
                        try {
                            gistsResponse = await fetch('https://api.github.com/gists', {
                                headers: { 
                                    'Authorization': `${prefix} ${token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            
                            if (gistsResponse.ok) {
                                gists = await gistsResponse.json();
                                break;
                            }
                        } catch (err) {
                            // 继续尝试下一种方式
                        }
                    }
                    
                    if (!gists) {
                        throw new Error('无法获取Gist列表，请检查Token权限');
                    }
                    
                    // 寻找我们专用的Gist
                    let spanGist = gists.find(g => g.description === 'SPAN_BOOKMARKS_DATA_STORAGE');
                    
                    if (!spanGist) {
                        // 创建新的Gist
                        let createResponse = null;
                        for (let prefix of tokenPrefixes) {
                            try {
                                createResponse = await fetch('https://api.github.com/gists', {
                                    method: 'POST',
                                    headers: { 
                                        'Authorization': `${prefix} ${token}`,
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/vnd.github.v3+json'
                                    },
                                    body: JSON.stringify({
                                        description: 'SPAN_BOOKMARKS_DATA_STORAGE',
                                        public: false,
                                        files: { 
                                            'data.json': { 
                                                content: JSON.stringify(this.userData, null, 2) 
                                            } 
                                        }
                                    })
                                });
                                
                                if (createResponse.ok) {
                                    spanGist = await createResponse.json();
                                    break;
                                }
                            } catch (err) {
                                // 继续尝试下一种方式
                            }
                        }
                        
                        if (!spanGist) {
                            throw new Error('创建Gist失败，请检查Token权限');
                        }
                    }
                    
                    userGistId = spanGist.id;
                    localStorage.setItem('user_gist_id', spanGist.id);
                    
                    el.newTokenInput.value = '';
                    this.showToast('Token已更新', 'success');
                    addLog('Token更新', 'Token已成功更新');
                    
                    // 更新显示
                    this.updateSyncSettingsDisplay();
                    
                    // 重启同步定时器
                    this.initSyncTimer();
                    
                    // 立即同步数据
                    setTimeout(() => this.syncToGist(), 1000);
                    
                } catch (error) {
                    console.error('更新Token失败:', error);
                    this.showToast('更新Token失败: ' + error.message, 'error');
                    addLog('Token更新', '更新Token失败: ' + error.message, 'error');
                }
            },
            
            // 清除Token
            clearToken: function() {
                if (confirm('确定要清除Token吗？这将断开与Gist的连接，但本地数据不会丢失。')) {
                    window.userToken = null;
                    userGistId = null;
                    localStorage.removeItem('github_token');
                    localStorage.removeItem('user_gist_id');
                    
                    // 清除同步定时器
                    if (syncTimer) {
                        clearInterval(syncTimer);
                        syncTimer = null;
                    }
                    
                    this.showToast('Token已清除', 'success');
                    addLog('Token清除', 'Token已清除');
                    
                    // 更新显示
                    this.updateSyncSettingsDisplay();
                }
            }
        };
        
        // 便签管理类
        class NotesManager {
            constructor(app) {
                this.app = app;
                this.notes = app.userData.notes || [];
                this.nextId = this.notes.length > 0 ? Math.max(...this.notes.map(note => note.id)) + 1 : 1;
                this.currentView = app.userData.settings.noteView || 'grid';
            }
            
            // 初始化便签
            init() {
                this.bindEvents();
                this.renderNotes();
            }
            
            // 绑定事件
            bindEvents() {
                const el = this.app.elements;
                if (el.newNoteBtn) el.newNoteBtn.addEventListener('click', () => this.createNote());
                if (el.gridViewBtn) el.gridViewBtn.addEventListener('click', () => this.switchView('grid'));
                if (el.listViewBtn) el.listViewBtn.addEventListener('click', () => this.switchView('list'));
            }
            
            // 切换视图
            switchView(view) {
                this.currentView = view;
                this.app.userData.settings.noteView = view;
                this.app.saveData();
                
                const el = this.app.elements;
                if (!el.gridViewBtn || !el.listViewBtn) return;
                
                if (view === 'grid') {
                    el.gridViewBtn.classList.add('active');
                    el.listViewBtn.classList.remove('active');
                    if (el.notesGrid) el.notesGrid.classList.remove('hidden');
                    if (el.notesList) el.notesList.classList.add('hidden');
                } else {
                    el.gridViewBtn.classList.remove('active');
                    el.listViewBtn.classList.add('active');
                    if (el.notesGrid) el.notesGrid.classList.add('hidden');
                    if (el.notesList) el.notesList.classList.remove('hidden');
                }
                
                this.renderNotes();
            }
            
            // 创建新便签
            createNote() {
                const newNote = {
                    id: this.nextId++,
                    content: '',
                    date: this.getCurrentDate(),
                    timestamp: Date.now(),
                    deleted: false,
                    deletedAt: null
                };
                
                this.notes.unshift(newNote); // 添加到开头
                this.app.saveData();
                this.renderNotes();
                this.app.showToast('新便签已创建');
                addLog('新建便签', '创建了新便签', 'success');
                
                // 聚焦到新便签的文本区域
                setTimeout(() => {
                    const newTextarea = document.querySelector(`.note-card[data-id="${newNote.id}"] .note-content`);
                    if (newTextarea) newTextarea.focus();
                }, 100);
                
                // 自动同步到Gist
                setTimeout(() => this.app.syncToGist(), 1000);
            }
            
            // 保存便签内容
            saveNoteContent(textarea) {
                const noteId = parseInt(textarea.closest('.note-card').dataset.id);
                const noteIndex = this.notes.findIndex(note => note.id === noteId);
                
                if (noteIndex !== -1) {
                    this.notes[noteIndex].content = textarea.value;
                    this.notes[noteIndex].timestamp = Date.now(); // 更新时间戳用于排序
                    this.notes[noteIndex].date = this.getCurrentDate(); // 更新日期
                    this.app.saveData();
                    
                    // 更新字符计数器
                    this.updateCharCounter(textarea);
                    
                    // 更新日期显示
                    const dateElement = textarea.closest('.note-card').querySelector('.note-date');
                    if (dateElement) {
                        dateElement.textContent = this.notes[noteIndex].date;
                    }
                    
                    // 显示保存提示
                    this.app.showToast('便签已保存');
                    addLog('保存便签', '便签内容已保存', 'info');
                    
                    // 自动同步到Gist
                    setTimeout(() => this.app.syncToGist(), 1000);
                }
            }
            
            // 更新字符计数器
            updateCharCounter(textarea) {
                const counter = textarea.closest('.note-card').querySelector('.char-counter');
                if (!counter) return;
                
                const charCount = textarea.value.length;
                
                // 不再限制字符数，只显示计数
                counter.textContent = `${charCount} 字符`;
                
                // 当字符数超过1000时，添加特殊样式提示
                if (charCount > 1000) {
                    counter.classList.add('large-count');
                } else {
                    counter.classList.remove('large-count');
                }
            }
            
            // 复制便签内容
            copyNoteContent(noteId) {
                const note = this.notes.find(note => note.id === noteId);
                if (!note) return;
                
                navigator.clipboard.writeText(note.content)
                    .then(() => this.app.showToast('便签内容已复制到剪贴板'))
                    .catch(() => {
                        // 如果clipboard API失败，使用备用方法
                        const textArea = document.createElement('textarea');
                        textArea.value = note.content;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.app.showToast('便签内容已复制到剪贴板');
                    });
                    
                addLog('复制便签', '便签内容已复制到剪贴板');
            }
            
            // 导出便签内容为TXT文件
            exportNoteContent(noteId) {
                const note = this.notes.find(note => note.id === noteId);
                if (!note) return;
                
                const content = note.content || '空便签';
                const dateStr = note.date.replace(/[\/\s:]/g, '-');
                const filename = `便签-${dateStr}.txt`;
                
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                
                this.app.showToast('便签已导出为TXT文件');
                addLog('导出便签', '便签已导出为TXT文件');
            }
            
            // 删除便签（移动到回收站）
            deleteNote(noteId) {
                const noteIndex = this.notes.findIndex(note => note.id === noteId);
                if (noteIndex === -1) return;
                
                if (!confirm('确定要删除这个便签吗？此操作会将便签移动到回收站。')) {
                    return;
                }
                
                this.notes[noteIndex].deleted = true;
                this.notes[noteIndex].deletedAt = new Date().toISOString();
                this.app.saveData();
                this.renderNotes();
                this.app.showToast('便签已移动到回收站');
                addLog('删除便签', '便签已移动到回收站', 'warning');
                
                // 自动同步到Gist
                setTimeout(() => this.app.syncToGist(), 1000);
            }
            
            // 渲染所有便签
            renderNotes() {
                const el = this.app.elements;
                if (!el.notesGrid || !el.notesList) return;
                
                const activeNotes = this.notes.filter(note => !note.deleted);
                
                // 按时间戳排序（最新的在前）
                activeNotes.sort((a, b) => b.timestamp - a.timestamp);
                
                // 清空容器
                el.notesGrid.innerHTML = '';
                el.notesList.innerHTML = '';
                
                // 如果没有便签，显示空状态
                if (activeNotes.length === 0) {
                    if (el.notesEmptyState) el.notesEmptyState.style.display = 'block';
                    return;
                }
                
                // 隐藏空状态
                if (el.notesEmptyState) el.notesEmptyState.style.display = 'none';
                
                // 渲染每个便签
                activeNotes.forEach(note => {
                    if (this.currentView === 'grid') {
                        const noteElement = this.createGridNoteElement(note);
                        el.notesGrid.appendChild(noteElement);
                    } else {
                        const noteElement = this.createListNoteElement(note);
                        el.notesList.appendChild(noteElement);
                    }
                });
            }
            
            // 创建网格视图便签元素
            createGridNoteElement(note) {
                const charCount = note.content.length;
                const manager = this;
                
                // 创建便签卡片
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';
                noteCard.dataset.id = note.id;
                
                // 创建便签内容
                noteCard.innerHTML = `
                    <textarea class="note-content" placeholder="在此输入便签内容...">${note.content}</textarea>
                    <div class="char-counter ${charCount > 1000 ? 'large-count' : ''}">${charCount} 字符</div>
                    <div class="note-footer">
                        <div class="note-date">${note.date}</div>
                        <div class="note-actions">
                            <button class="note-action-btn note-copy-btn" title="复制内容">
                                <i class="fas fa-copy"></i><span> 复制</span>
                            </button>
                            <button class="note-action-btn note-export-btn" title="导出为TXT">
                                <i class="fas fa-file-export"></i><span> 导出</span>
                            </button>
                            <button class="note-action-btn note-delete-btn" title="删除便签">
                                <i class="fas fa-trash"></i><span> 删除</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // 绑定事件
                this.bindNoteEvents(noteCard, note.id);
                
                return noteCard;
            }
            
            // 创建列表视图便签元素
            createListNoteElement(note) {
                const charCount = note.content.length;
                const manager = this;
                
                // 创建便签卡片
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';
                noteCard.dataset.id = note.id;
                
                // 创建便签内容
                noteCard.innerHTML = `
                    <textarea class="note-content" placeholder="在此输入便签内容...">${note.content}</textarea>
                    <div class="note-info">
                        <div class="char-counter ${charCount > 1000 ? 'large-count' : ''}">${charCount} 字符</div>
                        <div class="note-footer">
                            <div class="note-date">${note.date}</div>
                            <div class="note-actions">
                                <button class="note-action-btn note-copy-btn" title="复制内容">
                                    <i class="fas fa-copy"></i><span> 复制</span>
                                </button>
                                <button class="note-action-btn note-export-btn" title="导出为TXT">
                                    <i class="fas fa-file-export"></i><span> 导出</span>
                                </button>
                                <button class="note-action-btn note-delete-btn" title="删除便签">
                                    <i class="fas fa-trash"></i><span> 删除</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 绑定事件
                this.bindNoteEvents(noteCard, note.id);
                
                return noteCard;
            }
            
            // 绑定便签事件
            bindNoteEvents(noteCard, noteId) {
                const manager = this;
                const textarea = noteCard.querySelector('.note-content');
                const copyBtn = noteCard.querySelector('.note-copy-btn');
                const exportBtn = noteCard.querySelector('.note-export-btn');
                const deleteBtn = noteCard.querySelector('.note-delete-btn');
                
                // 自动保存（输入时防抖）
                let saveTimeout;
                textarea.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    manager.updateCharCounter(textarea);
                    
                    // 防抖保存，500ms后自动保存
                    saveTimeout = setTimeout(() => {
                        manager.saveNoteContent(textarea);
                    }, 500);
                });
                
                // 失去焦点时保存
                textarea.addEventListener('blur', () => {
                    manager.saveNoteContent(textarea);
                });
                
                // 点击卡片时添加选中效果
                noteCard.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('note-action-btn')) {
                        noteCard.classList.add('selected');
                        // 移除其他卡片的选中状态
                        document.querySelectorAll('.note-card.selected').forEach(card => {
                            if (card !== noteCard) card.classList.remove('selected');
                        });
                    }
                });
                
                // 按钮事件
                if (copyBtn) copyBtn.addEventListener('click', () => manager.copyNoteContent(noteId));
                if (exportBtn) exportBtn.addEventListener('click', () => manager.exportNoteContent(noteId));
                if (deleteBtn) deleteBtn.addEventListener('click', () => manager.deleteNote(noteId));
            }
            
            // 获取当前日期字符串
            getCurrentDate() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            }
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 已经通过checkTokenAndInitialize函数初始化
        });
    </script>
</body>
</html>